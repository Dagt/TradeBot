<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <link rel="icon" href="/static/favicon.ico">
  <title>DMI - TradingBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/styles.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <script src="/static/header.js" defer></script>
</head>
<body>
  <h1>Bots</h1>

  <div class="card">
    <h2>Nuevo bot</h2>
    <div class="grid3" style="margin-top:10px">
      <div>
        <label for="bot-strategy">Estrategia</label>
        <select id="bot-strategy"></select>
      </div>
      <div>
        <label for="bot-pairs">Pares (coma)</label>
        <input id="bot-pairs" placeholder="BTC/USDT,ETH/USDT"/>
      </div>
      <div id="field-venue">
        <label for="bot-venue">Venue</label>
        <select id="bot-venue">
          <option value="binance_spot">Binance Spot</option>
          <option value="binance_futures">Binance Futures</option>
          <option value="bybit_spot">Bybit Spot</option>
          <option value="bybit_futures">Bybit Futures</option>
          <option value="okx_spot">OKX Spot</option>
          <option value="okx_futures">OKX Futures</option>
        </select>
      </div>
      <div id="field-leverage">
        <label for="bot-leverage">Leverage</label>
        <input id="bot-leverage" type="number" step="1"/>
      </div>
      <div id="field-spot" style="display:none">
        <label for="bot-spot">Spot adapter</label>
        <select id="bot-spot">
          <option value="binance_spot">Binance Spot</option>
          <option value="binance_futures">Binance Futures</option>
          <option value="bybit_spot">Bybit Spot</option>
          <option value="bybit_futures">Bybit Futures</option>
          <option value="okx_spot">OKX Spot</option>
          <option value="okx_futures">OKX Futures</option>
        </select>
      </div>
      <div id="field-perp" style="display:none">
        <label for="bot-perp">Perp adapter</label>
        <select id="bot-perp">
          <option value="binance_futures">Binance Futures</option>
          <option value="bybit_futures">Bybit Futures</option>
          <option value="okx_futures">OKX Futures</option>
        </select>
      </div>
      <div id="field-threshold" style="display:none">
        <label for="bot-threshold">Threshold</label>
        <input id="bot-threshold" type="number" step="0.0001" value="0.001"/>
      </div>
      <div>
        <label for="bot-config">Config YAML</label>
        <input id="bot-config" placeholder="config.yaml"/>
      </div>
      <div>
        <label for="bot-risk-pct">Risk %</label>
        <input id="bot-risk-pct" type="number" step="0.0001" required/>
      </div>
      <div>
        <label for="bot-daily-max-loss-pct">Daily max loss %
          <span class="help-icon" title="Pérdida diaria máxima permitida (porcentaje del equity)">?</span>
        </label>
        <input id="bot-daily-max-loss-pct" type="number" step="0.0001"/>
      </div>
      <div>
        <label for="bot-daily-max-drawdown-pct">Daily max drawdown %
          <span class="help-icon" title="Drawdown diario máximo relativo al pico intradía">?</span>
        </label>
        <input id="bot-daily-max-drawdown-pct" type="number" step="0.0001"/>
      </div>
      <div>
        <label for="bot-timeframe">Timeframe</label>
        <select id="bot-timeframe">
          <option value="1m" selected>1m</option>
          <option value="5m">5m</option>
          <option value="15m">15m</option>
        </select>
      </div>
      <div>
        <label for="bot-env">Entorno</label>
        <select id="bot-env">
          <option value="live">Live</option>
          <option value="paper">Paper trading</option>
          <option value="testnet" selected>Testnet</option>
        </select>
      </div>
      <div id="field-toggle-params" style="display:flex;align-items:center;gap:4px">
        <span>Configurar parámetros</span>
        <label class="switch"><input id="bot-toggle-params" type="checkbox"><span class="slider"></span></label>
      </div>
    </div>
      <div id="bot-param-card" style="display:none">
        <div id="bot-strategy-params" class="param-grid"></div>
      </div>
      <button id="bot-start" style="margin-top:10px">Start</button>
    </div>

  <div class="card" style="margin-top:16px">
    <h2>Bots activos</h2>
    <div class="muted">Auto-refresh 5s</div>
    <div style="overflow:auto; max-height:60vh; margin-top:10px">
      <table id="tbl-bots">
        <thead><tr><th>PID</th><th>Estrategia</th><th>Pares</th><th>Estado</th><th>Orders/Fills</th><th>Cancel %</th><th>M/T</th><th>Fees</th><th>Slippage</th><th>Hit %</th><th>Duración</th><th>Exposure</th><th>Leverage</th><th>Risk</th><th>Error</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Comandos CLI</h2>
    <div class="muted">Ejecuta cualquier comando de <code>tradingbot.cli</code></div>
    <input id="cli-input" class="mono" placeholder="--help"/>
    <button id="cli-run" style="margin-top:8px">Ejecutar</button>
    <pre id="cli-output" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Gestión de riesgo</h2>
    <div class="muted">Consultar exposiciones y eventos o ejecutar acciones</div>
    <p class="muted" style="margin-top:8px">
      Términos:
      <code>total_notional</code><span class="help-icon" title="Valor notional total en USD de todas las posiciones abiertas">?</span>,
      <code>items</code><span class="help-icon" title="Listado de posiciones por símbolo">?</span>,
      <code>events</code><span class="help-icon" title="Historial reciente de eventos de riesgo">?</span>
    </p>
    <button id="risk-refresh">Consultar</button>
    <button id="risk-halt">Halt</button>
    <button id="risk-reset">Reset</button>
    <div id="risk-exposure" style="overflow:auto;margin-top:8px"></div>
    <div id="risk-events" style="overflow:auto;margin-top:8px"></div>
    <pre id="risk-error" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

<script>
const api = (path) => `${location.origin}${path}`;

  async function loadStrategies(){
    try{
      const r = await fetch(api('/strategies/status'));
      const j = await r.json();
      const sel = document.getElementById('bot-strategy');
      sel.innerHTML='';
      Object.keys(j.strategies || {}).forEach(s=>{
        const o=document.createElement('option');
        o.value=s; o.textContent=s; sel.appendChild(o);
      });
    updateForm();
    }catch(e){}
  }

async function loadStrategyParams(name){
  const container=document.getElementById('bot-strategy-params');
  container.innerHTML='';
  const card=document.getElementById('bot-param-card');
  card.style.display='none';
  const toggle=document.getElementById('bot-toggle-params');
  toggle.checked=false;
  const field=document.getElementById('field-toggle-params');
  field.style.display='none';

  try{
    const r=await fetch(api(`/strategies/${name}/schema`));
    const j=await r.json();
    const params=(j.params||[]).filter(p=>p.name!=='config_path');
    field.style.display=params.length?'':'none';
    params.forEach(p=>{
      const div=document.createElement('div');

      const label=document.createElement('label');
      label.htmlFor=`bot-param-${p.name}`;
      label.textContent=p.name;

      // siempre mostramos help-icon (aunque esté vacío, igual que en backtest)
      const help=document.createElement('span');
      help.className='help-icon';
      help.title=p.desc||'';
      help.textContent='?';
      label.appendChild(help);

      const input=document.createElement('input');
      input.className='param-input';
      input.id=`bot-param-${p.name}`;
      input.dataset.name=p.name;
      input.dataset.type=p.type||'';

      const type=(p.type||'').toLowerCase();
      if(type.includes('int')||type.includes('float')||type.includes('number')){
        input.type='number';
        input.step='0.0001';
      }else{
        input.type='text';
      }

      if(p.default!==undefined && p.default!==null) input.value=p.default;

      div.appendChild(label);
      div.appendChild(input);
      container.appendChild(div);
    });
  }catch(e){}
}


  function updateVenueFields(){
    const venue=document.getElementById('bot-venue').value;
    const strat=document.getElementById('bot-strategy').value;
    const cross=strat==='cross_arbitrage';
    const lev=document.getElementById('field-leverage');
    lev.style.display = (!cross && venue.endsWith('_futures')) ? '' : 'none';
  }

  async function updateForm(){
    const strat=document.getElementById('bot-strategy').value;
    const cross=strat==='cross_arbitrage';
    ['field-venue','field-risk-pct'].forEach(id=>{
      document.getElementById(id).style.display = cross ? 'none' : '';
    });
    ['field-spot','field-perp','field-threshold'].forEach(id=>{
      document.getElementById(id).style.display = cross ? '' : 'none';
    });
    await loadStrategyParams(strat);
    updateVenueFields();
  }

async function startBot(){
  const strategy = document.getElementById('bot-strategy').value;
  const pairs = document.getElementById('bot-pairs').value.split(',').map(s=>s.trim()).filter(Boolean);
  const venue = document.getElementById('bot-venue').value;
  const risk_pct = document.getElementById('bot-risk-pct').value;
  const daily_max_loss_pct = document.getElementById('bot-daily-max-loss-pct').value;
  const daily_max_drawdown_pct = document.getElementById('bot-daily-max-drawdown-pct').value;
  const leverage = document.getElementById('bot-leverage').value;
  const env = document.getElementById('bot-env').value;
  const testnet = env === 'testnet';
  const dry_run = env === 'paper';
  const config = document.getElementById('bot-config').value;
  const timeframe = document.getElementById('bot-timeframe').value;
    const spot = document.getElementById('bot-spot').value;
    const perp = document.getElementById('bot-perp').value;
    const threshold = document.getElementById('bot-threshold').value;
  const paramEls=document.querySelectorAll('#bot-strategy-params input');
    const params={};
    paramEls.forEach(el=>{
      if(!el.value) return;
      const t=(el.dataset.type||'').toLowerCase();
      let v=el.value;
      if(t.includes('int')) v=parseInt(v,10);
      else if(t.includes('float') || t.includes('number')) v=parseFloat(v);
      params[el.dataset.name]=v;
    });
    const payload = {strategy, pairs, venue, testnet, dry_run, timeframe};
    if(config) payload.config = config;
    if(risk_pct) payload.risk_pct = Number(risk_pct);
    if(daily_max_loss_pct) payload.daily_max_loss_pct = Number(daily_max_loss_pct);
    if(daily_max_drawdown_pct) payload.daily_max_drawdown_pct = Number(daily_max_drawdown_pct);
    if(leverage) payload.leverage = Number(leverage);
  if(strategy==='cross_arbitrage'){
    payload.spot = spot;
      payload.perp = perp;
      if(threshold) payload.threshold = Number(threshold);
    }
    if(Object.keys(params).length){
      try{ await fetch(api(`/strategies/${strategy}/params`), {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(params)}); }catch(e){}
    }
      try{
        const r = await fetch(api('/bots'), {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        await r.json();
        refreshBots();
    }catch(e){ console.error(e); }
  }

async function refreshBots(){
  try{
    const r = await fetch(api('/bots'));
    const j = await r.json();
    const body = document.querySelector('#tbl-bots tbody');
    body.innerHTML='';
    (j.bots||[]).forEach(b=>{
      const stats=b.stats||{};
      const pairs=(b.config?.pairs||[]).join(',');
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${b.pid}</td><td>${b.config?.strategy||''}</td><td>${pairs}</td><td>${b.status}</td>
      <td>${stats.orders_sent||0}/${stats.fills||0}</td>
      <td>${((stats.cancel_ratio||0)*100).toFixed(1)}%</td>
      <td>${(stats.maker_taker_ratio||0).toFixed(2)}</td>
      <td>${(stats.fees_usd||0).toFixed(2)}</td>
      <td>${(stats.slippage_bps||0).toFixed(2)}</td>
      <td>${((stats.hit_rate||0)*100).toFixed(1)}%</td>
      <td>${(stats.avg_trade_duration||0).toFixed(1)}</td>
      <td>${(stats.inventory||0).toFixed(4)}</td>
      <td>${(stats.leverage||0).toFixed(2)}</td>
      <td>${stats.risk_triggers||0}</td>
      <td>${b.last_error||''}</td>
      <td>
  <button class="icon-btn" onclick="pauseBot(${b.pid})" title="Pause">
    <i class="fa-solid fa-pause"></i>
  </button>
  <button class="icon-btn" onclick="resumeBot(${b.pid})" title="Resume">
    <i class="fa-solid fa-play"></i>
  </button>
  <button class="icon-btn warn" onclick="haltBot(${b.pid})" title="Halt">
    <i class="fa-solid fa-ban"></i>
  </button>
  <button class="icon-btn" onclick="stopBot(${b.pid})" title="Stop">
    <i class="fa-solid fa-stop"></i>
  </button>
  <button class="icon-btn danger" onclick="killBot(${b.pid})" title="Kill">
    <i class="fa-solid fa-skull"></i>
  </button>
  <button class="icon-btn danger" onclick="deleteBot(${b.pid})" title="Delete">
    <i class="fa-solid fa-trash"></i>
  </button>
</td>
`;
      body.appendChild(tr);
    });
  }catch(e){}
}

async function runCli(){
  const cmd = document.getElementById('cli-input').value;
  if(!cmd.trim()) return;
  try{
    const r = await fetch(api('/cli/run'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({command: cmd})});
    const j = await r.json();
    const out = (j.stdout||'') + (j.stderr ? '\n'+j.stderr : '');
    document.getElementById('cli-output').textContent = out;
  }catch(e){
    document.getElementById('cli-output').textContent = String(e);
  }
}

async function stopBot(pid){ await fetch(api(`/bots/${pid}/stop`), {method:'POST'}); refreshBots(); }
async function pauseBot(pid){ await fetch(api(`/bots/${pid}/pause`), {method:'POST'}); refreshBots(); }
async function resumeBot(pid){ await fetch(api(`/bots/${pid}/resume`), {method:'POST'}); refreshBots(); }
async function haltBot(pid){ await fetch(api('/risk/halt'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reason:`bot ${pid}`})}); refreshBots(); }
async function killBot(pid){ await fetch(api(`/bots/${pid}/kill`), {method:'POST'}); refreshBots(); }
async function deleteBot(pid){ await fetch(api(`/bots/${pid}`), {method:'DELETE'}); refreshBots(); }

function renderExposure(data){
  const div=document.getElementById('risk-exposure');
  const items=data.items||[];
  let html=`<div><strong>Total notional:</strong> ${Number(data.total_notional||0).toFixed(2)}</div>`;
  if(items.length){
    html+='<table><thead><tr><th>Symbol</th><th>Position</th><th>Precio</th><th>Notional USD</th></tr></thead><tbody>';
    items.forEach(i=>{
      html+=`<tr><td>${i.symbol}</td><td>${Number(i.position||0).toFixed(8)}</td><td>${Number(i.price||0).toFixed(4)}</td><td>${Number(i.notional_usd||0).toFixed(2)}</td></tr>`;
    });
    html+='</tbody></table>';
  }
  div.innerHTML=html;
}

function renderEvents(items){
  const div=document.getElementById('risk-events');
  if(!(items&&items.length)){
    div.innerHTML='';
    return;
  }
  let html='<table><thead><tr><th>Tiempo</th><th>Symbol</th><th>Tipo</th><th>Mensaje</th></tr></thead><tbody>';
  items.forEach(ev=>{
    const ts=ev.ts?new Date(ev.ts).toLocaleString():'';
    html+=`<tr><td>${ts}</td><td>${ev.symbol||''}</td><td>${ev.kind||''}</td><td>${ev.message||''}</td></tr>`;
  });
  html+='</tbody></table>';
  div.innerHTML=html;
}

async function refreshRisk(){
  try{
    const ex = await fetch(api('/risk/exposure'));
    const exj = await ex.json();
    const ev = await fetch(api('/risk/events?limit=20'));
    const evj = await ev.json();
    renderExposure(exj);
    renderEvents(evj.items||evj.events||[]);
    document.getElementById('risk-error').textContent='';
  }catch(e){
    document.getElementById('risk-error').textContent = String(e);
  }
}

async function haltRisk(){
  try{
    await fetch(api('/risk/halt'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reason:'dashboard'})});
    refreshRisk();
  }catch(e){
    document.getElementById('risk-error').textContent = String(e);
  }
}

async function resetRisk(){
  try{
    await fetch(api('/risk/reset'), {method:'POST'});
    refreshRisk();
  }catch(e){
    document.getElementById('risk-error').textContent = String(e);
  }
}

document.getElementById('bot-start').addEventListener('click', startBot);
document.getElementById('bot-strategy').addEventListener('change', updateForm);
document.getElementById('bot-venue').addEventListener('change', updateVenueFields);
document.getElementById('bot-toggle-params').addEventListener('change', e => {
  document.getElementById('bot-param-card').style.display = e.target.checked ? 'block' : 'none';
});
loadStrategies();
updateVenueFields();
refreshBots();
setInterval(refreshBots,5000);
document.getElementById('cli-run').addEventListener('click', runCli);
document.getElementById('risk-refresh').addEventListener('click', refreshRisk);
document.getElementById('risk-halt').addEventListener('click', haltRisk);
document.getElementById('risk-reset').addEventListener('click', resetRisk);
refreshRisk();
</script>
</body>
</html>

