<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <link rel="icon" href="/static/favicon.ico">
  <title>DMI - TradingBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/styles.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <script src="/static/header.js" defer></script>
</head>
<body>
  <h1>Bots</h1>

  <div class="card">
    <h2>Nuevo bot</h2>
    <div class="grid5" style="margin-top:10px">
      <div>
        <label for="bot-strategy">Estrategia</label>
        <select id="bot-strategy"></select>
      </div>
      <div>
        <label for="bot-pairs">Pares (coma)</label>
        <input id="bot-pairs" placeholder="BTC/USDT,ETH/USDT"/>
      </div>
      <div id="field-venue">
        <label for="bot-venue">Venue</label>
        <select id="bot-venue">
          <option value="binance_spot">Binance Spot</option>
          <option value="binance_futures">Binance Futures</option>
          <option value="bybit_spot">Bybit Spot</option>
          <option value="bybit_futures">Bybit Futures</option>
          <option value="okx_spot">OKX Spot</option>
          <option value="okx_futures">OKX Futures</option>
        </select>
      </div>
      <div id="field-leverage">
        <label for="bot-leverage">Leverage</label>
        <input id="bot-leverage" type="number" step="1"/>
      </div>
      <div id="field-spot" style="display:none">
        <label for="bot-spot">Spot adapter</label>
        <select id="bot-spot">
          <option value="binance_spot">Binance Spot</option>
          <option value="binance_futures">Binance Futures</option>
          <option value="bybit_spot">Bybit Spot</option>
          <option value="bybit_futures">Bybit Futures</option>
          <option value="okx_spot">OKX Spot</option>
          <option value="okx_futures">OKX Futures</option>
        </select>
      </div>
      <div id="field-perp" style="display:none">
        <label for="bot-perp">Perp adapter</label>
        <select id="bot-perp">
          <option value="binance_futures">Binance Futures</option>
          <option value="bybit_futures">Bybit Futures</option>
          <option value="okx_futures">OKX Futures</option>
        </select>
      </div>
      <div id="field-threshold" style="display:none">
        <label for="bot-threshold">Threshold</label>
        <input id="bot-threshold" type="number" step="0.0001" value="0.001"/>
      </div>
      <div>
        <label for="bot-config">Config YAML</label>
        <input id="bot-config" placeholder="config.yaml"/>
      </div>
      <div id="field-risk-pct">
  <label for="bot-risk-pct">Risk %</label>
  <input id="bot-risk-pct" type="number" step="0.01" required/>
</div>
      <div>
        <label for="bot-daily-max-loss-pct">Daily max loss %
          <span class="help-icon" title="Pérdida diaria máxima permitida (porcentaje del equity)">?</span>
        </label>
        <input id="bot-daily-max-loss-pct" type="number" step="0.01"/>
      </div>
      <div>
        <label for="bot-daily-max-drawdown-pct">Daily max drawdown %
          <span class="help-icon" title="Drawdown diario máximo relativo al pico intradía">?</span>
        </label>
        <input id="bot-daily-max-drawdown-pct" type="number" step="0.01"/>
      </div>
      <div>
        <label for="bot-timeframe">Timeframe</label>
        <select id="bot-timeframe">
          <option value="1m" selected>1m</option>
          <option value="3m">3m</option>
          <option value="5m">5m</option>
          <option value="15m">15m</option>
          <option value="30m">30m</option>
          <option value="4h">4h</option>
        </select>
      </div>
      <div>
        <label for="bot-env">Entorno</label>
        <select id="bot-env">
          <option value="live">Live</option>
          <option value="paper">Paper trading</option>
          <option value="testnet" selected>Testnet</option>
        </select>
      </div>
      <div id="field-initial-cash" style="display:none">
        <label for="bot-initial-cash">Initial cash</label>
        <input id="bot-initial-cash" type="number" step="0.01"/>
      </div>
      <div id="field-toggle-params" style="display:flex;align-items:center;gap:4px">
        <span>Configurar parámetros</span>
        <label id="bot-config-toggle" class="switch"><input id="bot-toggle-params" type="checkbox"><span class="slider"></span></label>
      </div>
    </div>
      <div id="bot-param-card" style="display:none">
        <div id="bot-strategy-params" class="param-grid"></div>
      </div>
      <button id="bot-start" style="margin-top:10px">Start</button>
    </div>

  <div class="card" style="margin-top:16px">
    <h2>Bots activos</h2>
    <div class="muted">Auto-refresh 5s</div>
    <div style="overflow:auto; max-height:60vh; margin-top:10px">
      <table id="tbl-bots">
        <thead><tr><th>PID</th><th>Bot</th><th>Pares</th><th>Estado</th><th>Orders</th><th>Fills</th><th>PnL</th><th>Cancel %</th><th>M/T</th><th>Fees</th><th>Slippage</th><th>Hit %</th><th>Locked (USD)</th><th>Exposure</th><th>Leverage</th><th>Risk</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Comandos CLI</h2>
    <div class="muted">Ejecuta cualquier comando de <code>tradingbot.cli</code></div>
    <input id="cli-input" class="mono" placeholder="--help"/>
    <button id="cli-run" style="margin-top:8px">Ejecutar</button>
    <pre id="cli-output" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Gestión de riesgo</h2>
    <div class="muted">Consultar exposiciones y eventos o ejecutar acciones</div>
    <p class="muted" style="margin-top:8px">
      Términos:
      <code>total_notional</code><span class="help-icon" title="Valor notional total en USD de todas las posiciones abiertas">?</span>,
      <code>items</code><span class="help-icon" title="Listado de posiciones por símbolo">?</span>,
      <code>events</code><span class="help-icon" title="Historial reciente de eventos de riesgo">?</span>
    </p>
    <button id="risk-refresh">Consultar</button>
    <button id="risk-halt">Halt</button>
    <button id="risk-reset">Reset</button>
    <div id="risk-exposure" style="overflow:auto;margin-top:8px"></div>
    <div id="risk-events" style="overflow:auto;margin-top:8px"></div>
    <pre id="risk-error" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

<script>
const api = (path) => `${location.origin}${path}`;

  async function loadStrategies(){
    try{
      const r = await fetch(api('/strategies/status'));
      const j = await r.json();
      const sel = document.getElementById('bot-strategy');
      sel.replaceChildren();
      Object.keys(j.strategies || {}).forEach(s=>{
        const o=document.createElement('option');
        o.value=s; o.textContent=s; sel.appendChild(o);
      });
    updateForm();
    }catch(e){}
  }

async function loadStrategyParams(name){
  const container=document.getElementById('bot-strategy-params');
  container.replaceChildren();
  const card=document.getElementById('bot-param-card');
  card.style.display='none';
  const toggle=document.getElementById('bot-toggle-params');
  toggle.checked=false;
  const field=document.getElementById('field-toggle-params');
  field.style.display='none';

  try{
    const r=await fetch(api(`/strategies/${name}/schema`));
    const j=await r.json();
    const params=(j.params||[]).filter(p=>p.name!=='config_path');
    field.style.display=params.length?'':'none';
    params.forEach(p=>{
      const div=document.createElement('div');

      const label=document.createElement('label');
      label.htmlFor=`bot-param-${p.name}`;
      label.textContent=p.name;

      // siempre mostramos help-icon (aunque esté vacío, igual que en backtest)
      const help=document.createElement('span');
      help.className='help-icon';
      help.title=p.desc||'';
      help.textContent='?';
      label.appendChild(help);

      const input=document.createElement('input');
      input.className='param-input';
      input.id=`bot-param-${p.name}`;
      input.dataset.name=p.name;
      input.dataset.type=p.type||'';

      const type=(p.type||'').toLowerCase();
      if(type.includes('int')||type.includes('float')||type.includes('number')){
        input.type='number';
        input.step='0.0001';
      }else{
        input.type='text';
      }

      if(p.default!==undefined && p.default!==null) input.value=p.default;

      div.appendChild(label);
      div.appendChild(input);
      container.appendChild(div);
    });
  }catch(e){}
}


  function updateVenueFields(){
    const venue=document.getElementById('bot-venue').value;
    const strat=document.getElementById('bot-strategy').value;
    const cross=strat==='cross_arbitrage';
    const lev=document.getElementById('field-leverage');
    lev.style.display = (!cross && venue.endsWith('_futures')) ? '' : 'none';
  }

  function updateEnvFields(){
    const env=document.getElementById('bot-env').value;
    document.getElementById('field-initial-cash').style.display = env==='paper' ? '' : 'none';
  }

  async function updateForm(){
  const strat = document.getElementById('bot-strategy').value;
  const cross = strat === 'cross_arbitrage';

  ['field-venue','field-risk-pct'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.style.display = cross ? 'none' : '';
  });

  ['field-spot','field-perp','field-threshold'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.style.display = cross ? '' : 'none';
  });

  await loadStrategyParams(strat);
  updateVenueFields();
}


async function startBot(){
  const btn = document.getElementById('bot-start');
  if(btn.disabled) return;
  btn.disabled = true;
  const strategy = document.getElementById('bot-strategy').value;
  const pairs = document.getElementById('bot-pairs').value.split(',').map(s=>s.trim()).filter(Boolean);
  const venue = document.getElementById('bot-venue').value;
  const risk_pct = document.getElementById('bot-risk-pct').value;
  const daily_max_loss_pct = document.getElementById('bot-daily-max-loss-pct').value;
  const daily_max_drawdown_pct = document.getElementById('bot-daily-max-drawdown-pct').value;
  const leverage = document.getElementById('bot-leverage').value;
  const env = document.getElementById('bot-env').value;
  const initial_cash = document.getElementById('bot-initial-cash').value;
  const testnet = env === 'testnet';
  const dry_run = env === 'paper';
  const config = document.getElementById('bot-config').value;
  const timeframe = document.getElementById('bot-timeframe').value;
    const spot = document.getElementById('bot-spot').value;
    const perp = document.getElementById('bot-perp').value;
    const threshold = document.getElementById('bot-threshold').value;
  const paramEls=document.querySelectorAll('#bot-strategy-params input');
    const params={};
    paramEls.forEach(el=>{
      if(!el.value) return;
      const t=(el.dataset.type||'').toLowerCase();
      let v=el.value;
      if(t.includes('int')) v=parseInt(v,10);
      else if(t.includes('float') || t.includes('number')) v=parseFloat(v);
      params[el.dataset.name]=v;
    });

    const payload = {strategy, pairs, venue, testnet, dry_run, timeframe};
    if(env==='paper' && initial_cash) payload.initial_cash = Number(initial_cash);
    if(config) payload.config = config;
    if(risk_pct) payload.risk_pct = Number(risk_pct) / 100;
    if(daily_max_loss_pct) payload.daily_max_loss_pct = Number(daily_max_loss_pct) / 100;
    if(daily_max_drawdown_pct) payload.daily_max_drawdown_pct = Number(daily_max_drawdown_pct) / 100;
    if(leverage) payload.leverage = Number(leverage);
  if(strategy==='cross_arbitrage'){
    payload.spot = spot;
      payload.perp = perp;
      if(threshold) payload.threshold = Number(threshold);
    }
    if(Object.keys(params).length){
      try{ await fetch(api(`/strategies/${strategy}/params`), {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(params)}); }catch(e){}
    }
    payload.metrics_port = 0;
      try{
        const r = await fetch(api('/bots'), {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        await r.json();
        refreshBots();
    }catch(e){ console.error(e); }
    finally{ btn.disabled = false; }
  }

async function refreshBots(){
  try{
    const r = await fetch(api('/bots'));
    const j = await r.json();
    const body = document.querySelector('#tbl-bots tbody');
    body.replaceChildren();
    (j.bots||[]).forEach(b=>{
      const stats=b.stats||{};
      const pairs=(b.config?.pairs||[]).join(',');
      const venue = b.config?.venue || '';
      const timeframe = b.config?.timeframe || '';
      const env = b.config?.dry_run ? 'paper'
                 : (b.config?.testnet ? 'testnet' : 'live');
      const tr=document.createElement('tr');

      const tdPid=document.createElement('td');
      tdPid.textContent=String(b.pid);
      tr.appendChild(tdPid);

      const tdStrategy=document.createElement('td');
      const divName=document.createElement('div');
      divName.textContent=b.config?.strategy || '';
      tdStrategy.appendChild(divName);
      const divMeta=document.createElement('div');
      divMeta.className='muted bot-meta';
      const spanEnv=document.createElement('span');
      spanEnv.className=`env-dot env-${env}`;
      spanEnv.title=env;
      divMeta.appendChild(spanEnv);
      divMeta.appendChild(document.createTextNode(` ${venue} • ${timeframe}`));
      tdStrategy.appendChild(divMeta);
      tr.appendChild(tdStrategy);

      const tdPairs=document.createElement('td');
      tdPairs.textContent=pairs;
      tr.appendChild(tdPairs);

      const tdStatus=document.createElement('td');
      tdStatus.textContent=b.status;
      tr.appendChild(tdStatus);

      const cells=[
        stats.orders||0,
        stats.fills||0,
        (stats.pnl||0).toFixed(2),
        `${((stats.cancel_ratio||0)*100).toFixed(1)}%`,
        (stats.maker_taker_ratio||0).toFixed(2),
        (stats.fees_usd||0).toFixed(2),
        (stats.slippage_bps||0).toFixed(2),
        `${((stats.hit_rate||0)*100).toFixed(1)}%`,
        (stats.locked||0).toFixed(2),
        (stats.exposure||0).toFixed(4),
        (stats.leverage||0).toFixed(2),
        `${((b.risk_pct ?? 0)*100).toFixed(2)}%`
      ];
      cells.forEach(v=>{
        const td=document.createElement('td');
        td.textContent=String(v);
        tr.appendChild(td);
      });

      const tdActions=document.createElement('td');

      const btnLogs=document.createElement('button');
      btnLogs.className='icon-btn';
      btnLogs.onclick=()=>showLogs(b.pid);
      btnLogs.title='Logs';
      const iconLogs=document.createElement('i');
      iconLogs.className='fa-solid fa-file-lines';
      btnLogs.appendChild(iconLogs);
      tdActions.appendChild(btnLogs);

      const btnPause=document.createElement('button');
      btnPause.className='icon-btn';
      btnPause.onclick=()=>pauseBot(b.pid);
      btnPause.title='Pause';
      const iconPause=document.createElement('i');
      iconPause.className='fa-solid fa-pause';
      btnPause.appendChild(iconPause);
      tdActions.appendChild(btnPause);

      const btnResume=document.createElement('button');
      btnResume.className='icon-btn';
      btnResume.onclick=()=>resumeBot(b.pid);
      btnResume.title='Resume';
      const iconResume=document.createElement('i');
      iconResume.className='fa-solid fa-play';
      btnResume.appendChild(iconResume);
      tdActions.appendChild(btnResume);

      const btnKill=document.createElement('button');
      btnKill.className='icon-btn danger';
      btnKill.onclick=()=>killBot(b.pid);
      btnKill.title='Kill';
      const iconKill=document.createElement('i');
      iconKill.className='fa-solid fa-skull';
      btnKill.appendChild(iconKill);
      tdActions.appendChild(btnKill);

      const btnDelete=document.createElement('button');
      btnDelete.className='icon-btn danger';
      btnDelete.onclick=()=>deleteBot(b.pid);
      btnDelete.title='Stop & Delete';
      const iconDelete=document.createElement('i');
      iconDelete.className='fa-solid fa-trash';
      btnDelete.appendChild(iconDelete);
      tdActions.appendChild(btnDelete);

      tr.appendChild(tdActions);

      body.appendChild(tr);
    });
  }catch(e){}
}

async function runCli(){
  const cmd = document.getElementById('cli-input').value;
  if(!cmd.trim()) return;
  try{
    const r = await fetch(api('/cli/run'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({command: cmd})});
    const j = await r.json();
    const out = (j.stdout||'') + (j.stderr ? '\n'+j.stderr : '');
    document.getElementById('cli-output').textContent = out;
  }catch(e){
    document.getElementById('cli-output').textContent = String(e);
  }
}

async function stopBot(pid){
  try{
    const r = await fetch(api(`/bots/${pid}/stop`), {method:'POST'});
    console.log('stopBot', pid, r.status);
  }catch(e){
    console.log('stopBot error', e);
  }
  refreshBots();
}

async function haltBot(pid){
  try{
    const r = await fetch(api(`/bots/${pid}/halt`), {method:'POST'});
    console.log('haltBot', pid, r.status);
  }catch(e){
    console.log('haltBot error', e);
  }
  refreshBots();
}
async function pauseBot(pid){
  try{
    const r = await fetch(api(`/bots/${pid}/pause`), {method:'POST'});
    console.log('pauseBot', pid, r.status);
  }catch(e){
    console.log('pauseBot error', e);
  }
  refreshBots();
}
async function resumeBot(pid){
  try{
    const r = await fetch(api(`/bots/${pid}/resume`), {method:'POST'});
    console.log('resumeBot', pid, r.status);
  }catch(e){
    console.log('resumeBot error', e);
  }
  refreshBots();
}
async function killBot(pid){
  try{
    const r = await fetch(api(`/bots/${pid}/kill`), {method:'POST'});
    console.log('killBot', pid, r.status);
  }catch(e){
    console.log('killBot error', e);
  }
  refreshBots();
}
async function deleteBot(pid){
  try{
    const stop = await fetch(api(`/bots/${pid}/stop`), {method:'POST'});
    console.log('stopBot', pid, stop.status);
    if(stop.ok){
      await fetch(api(`/bots/${pid}`), {method:'DELETE'});
      console.log('deleteBot', pid);
    }
  }catch(e){
    console.log('deleteBot error', e);
  }
  refreshBots();
}

function renderExposure(data){
  const div=document.getElementById('risk-exposure');
  const items=data.items||[];
  div.replaceChildren();
  const total=document.createElement('div');
  const strong=document.createElement('strong');
  strong.textContent='Total notional:';
  total.appendChild(strong);
  total.appendChild(document.createTextNode(` ${Number(data.total_notional||0).toFixed(2)}`));
  div.appendChild(total);

  if(items.length){
    const table=document.createElement('table');
    const thead=document.createElement('thead');
    const trHead=document.createElement('tr');
    ['Symbol','Position','Precio','Notional USD'].forEach(h=>{
      const th=document.createElement('th');
      th.textContent=h;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    table.appendChild(thead);

    const tbody=document.createElement('tbody');
    items.forEach(i=>{
      const tr=document.createElement('tr');
      const vals=[
        i.symbol,
        Number(i.position||0).toFixed(8),
        Number(i.price||0).toFixed(4),
        Number(i.notional_usd||0).toFixed(2)
      ];
      vals.forEach(v=>{
        const td=document.createElement('td');
        td.textContent=String(v);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    div.appendChild(table);
  }
}

function renderEvents(items){
  const div=document.getElementById('risk-events');
  if(!(items&&items.length)){
    div.replaceChildren();
    return;
  }
  div.replaceChildren();
  const table=document.createElement('table');
  const thead=document.createElement('thead');
  const trHead=document.createElement('tr');
  ['Tiempo','Symbol','Tipo','Mensaje'].forEach(h=>{
    const th=document.createElement('th');
    th.textContent=h;
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);
  table.appendChild(thead);
  const tbody=document.createElement('tbody');
  items.forEach(ev=>{
    const tr=document.createElement('tr');
    const ts=ev.ts?new Date(ev.ts).toLocaleString():'';
    [ts, ev.symbol||'', ev.kind||'', ev.message||''].forEach(v=>{
      const td=document.createElement('td');
      td.textContent=String(v);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  div.appendChild(table);
}

async function refreshRisk(){
  try{
    const ex = await fetch(api('/risk/exposure'));
    const exj = await ex.json();
    const ev = await fetch(api('/risk/events?limit=20'));
    const evj = await ev.json();
    renderExposure(exj);
    renderEvents(evj.items||evj.events||[]);
    document.getElementById('risk-error').textContent='';
  }catch(e){
    document.getElementById('risk-error').textContent = String(e);
  }
}

async function haltRisk(){
  try{
    await fetch(api('/risk/halt'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reason:'dashboard'})});
    refreshRisk();
    refreshBots();
  }catch(e){
    document.getElementById('risk-error').textContent = String(e);
  }
}

async function resetRisk(){
  try{
    await fetch(api('/risk/reset'), {method:'POST'});
    refreshRisk();
  }catch(e){
    document.getElementById('risk-error').textContent = String(e);
  }
}

  document.getElementById('bot-start').onclick = startBot;
  document.getElementById('bot-strategy').addEventListener('change', updateForm);
  document.getElementById('bot-venue').addEventListener('change', updateVenueFields);
  document.getElementById('bot-env').addEventListener('change', updateEnvFields);
  document.getElementById('bot-toggle-params').addEventListener('change', e => {
    document.getElementById('bot-param-card').style.display = e.target.checked ? 'block' : 'none';
  });
  loadStrategies();
  loadStrategyParams(document.getElementById('bot-strategy').value);
  updateVenueFields();
  updateEnvFields();
  refreshBots();
  setInterval(refreshBots,5000);
  document.getElementById('cli-run').addEventListener('click', runCli);
  document.getElementById('risk-refresh').addEventListener('click', refreshRisk);
  document.getElementById('risk-halt').addEventListener('click', haltRisk);
  document.getElementById('risk-reset').addEventListener('click', resetRisk);
  refreshRisk();

let logSource=null;
function showLogs(pid){
  const dlg=document.getElementById('logs-dialog');
  const pre=document.getElementById('logs-content');
  pre.textContent='';
  if(logSource){ logSource.close(); }
  logSource=new EventSource(api(`/bots/${pid}/logs`));
  logSource.onmessage=(e)=>{
    pre.textContent+=e.data+'\n';
    pre.scrollTop=pre.scrollHeight;
  };
  logSource.addEventListener('end', ()=>{ if(logSource){logSource.close();} });
  dlg.showModal();
}
function closeLogs(){
  if(logSource){ logSource.close(); logSource=null; }
  document.getElementById('logs-dialog').close();
}
</script>

<dialog id="logs-dialog">
  <pre id="logs-content" class="mono"></pre>
  <div style="text-align:right;margin-top:8px">
    <button onclick="closeLogs()">Cerrar</button>
  </div>
</dialog>
</body>
</html>

