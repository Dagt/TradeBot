<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <link rel="icon" href="/static/favicon.ico">
  <title>DMI - TradingBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/styles.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-+0Y4FzfwS0Ax7AnCM1j7rwhhtjfiPgk41IrT9jp+1rssZCvGSqtEtFPi0P5xGX2YeliYg+6TSGT+bVfVgY2G4w==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
</head>
<body>
<header class="center" style="margin-bottom:8px">
  <div class="logo-wrap">
  <img src="/static/logo.png" alt="DMI Bot Trading" class="logo">
</div>
  <nav>
  <div class="menu">
    <a href="/" class="">Monitoreo</a>
    <a href="/bots" class="active">Bots</a>
    <a href="/stats" class="">Estadísticas operativas</a>
    <a href="/data" class="">Datos históricos</a>
    <a href="/backtest" class="">Backtest</a>
    <a href="http://localhost:3000/" target="_blank" class="">Grafana</a>
    <a href="http://localhost:9090/" target="_blank" class="">Prometheus</a>
  </div>
</nav>

</header>
  <h1>Bots</h1>

  <div class="card">
    <h2>Nuevo bot</h2>
    <div class="grid3" style="margin-top:10px">
      <div>
        <label for="bot-strategy">Estrategia</label>
        <select id="bot-strategy"></select>
      </div>
      <div>
        <label for="bot-pairs">Pares (coma)</label>
        <input id="bot-pairs" placeholder="BTC/USDT,ETH/USDT"/>
      </div>
      <div id="field-exchange">
        <label for="bot-exchange">Exchange</label>
        <select id="bot-exchange">
          <option value="binance">Binance</option>
          <option value="bybit">Bybit</option>
          <option value="okx">OKX</option>
        </select>
      </div>
      <div id="field-market">
        <label for="bot-market">Mercado</label>
        <select id="bot-market">
          <option value="spot">Spot</option>
          <option value="futures">Futuros</option>
        </select>
      </div>
      <div id="field-leverage">
        <label for="bot-leverage">Leverage</label>
        <input id="bot-leverage" type="number" step="1"/>
      </div>
      <div id="field-spot" style="display:none">
        <label for="bot-spot">Spot adapter</label>
        <select id="bot-spot">
          <option value="binance_spot">Binance Spot</option>
          <option value="binance_futures">Binance Futures</option>
          <option value="bybit_spot">Bybit Spot</option>
          <option value="bybit_futures">Bybit Futures</option>
          <option value="okx_spot">OKX Spot</option>
          <option value="okx_futures">OKX Futures</option>
        </select>
      </div>
      <div id="field-perp" style="display:none">
        <label for="bot-perp">Perp adapter</label>
        <select id="bot-perp">
          <option value="binance_futures">Binance Futures</option>
          <option value="bybit_futures">Bybit Futures</option>
          <option value="okx_futures">OKX Futures</option>
        </select>
      </div>
      <div id="field-threshold" style="display:none">
        <label for="bot-threshold">Threshold</label>
        <input id="bot-threshold" type="number" step="0.0001" value="0.001"/>
      </div>
      <div>
        <label for="bot-config">Config YAML</label>
        <input id="bot-config" placeholder="config.yaml"/>
      </div>
      <div>
        <label for="bot-risk-pct">Risk %</label>
        <input id="bot-risk-pct" type="number" step="0.0001" required/>
      </div>
      <div>
        <label for="bot-daily-max-loss-pct">Daily max loss %
          <span class="help-icon" title="Pérdida diaria máxima permitida (porcentaje del equity)">?</span>
        </label>
        <input id="bot-daily-max-loss-pct" type="number" step="0.0001"/>
      </div>
      <div>
        <label for="bot-daily-max-drawdown-pct">Daily max drawdown %
          <span class="help-icon" title="Drawdown diario máximo relativo al pico intradía">?</span>
        </label>
        <input id="bot-daily-max-drawdown-pct" type="number" step="0.0001"/>
      </div>
      <div>
        <label for="bot-env">Entorno</label>
        <select id="bot-env">
          <option value="live">Live</option>
          <option value="paper">Paper trading</option>
          <option value="testnet" selected>Testnet</option>
        </select>
      </div>
      <div id="field-toggle-params" style="display:flex;align-items:center;gap:4px">
        <span>Configurar parámetros</span>
        <label class="switch"><input id="bot-toggle-params" type="checkbox"><span class="slider"></span></label>
      </div>
    </div>
      <div id="bot-param-card" style="display:none">
        <div id="bot-strategy-params" class="param-grid"></div>
      </div>
      <p id="bot-strategy-info" class="dm-kind-desc" style="grid-column:1 / -1;"></p>
      <button id="bot-start" style="margin-top:10px">Start</button>
      <pre id="bot-output" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
    </div>

  <div class="card" style="margin-top:16px">
    <h2>Bots activos</h2>
    <div class="muted">Auto-refresh 5s</div>
    <div style="overflow:auto; max-height:60vh; margin-top:10px">
      <table id="tbl-bots">
        <thead><tr><th>PID</th><th>Estrategia</th><th>Pares</th><th>Estado</th><th>Orders/Fills</th><th>Cancel %</th><th>M/T</th><th>Fees</th><th>Slippage</th><th>Hit %</th><th>Duración</th><th>Exposure</th><th>Leverage</th><th>Risk</th><th>Error</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Comandos CLI</h2>
    <div class="muted">Ejecuta cualquier comando de <code>tradingbot.cli</code></div>
    <input id="cli-input" class="mono" placeholder="--help"/>
    <button id="cli-run" style="margin-top:8px">Ejecutar</button>
    <pre id="cli-output" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Gestión de riesgo</h2>
    <div class="muted">Consultar exposiciones y eventos o ejecutar acciones</div>
    <button id="risk-refresh">Consultar</button>
    <button id="risk-halt">Halt</button>
    <button id="risk-reset">Reset</button>
    <pre id="risk-output" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

<script>
const api = (path) => `${location.origin}${path}`;

const dataInfo = {
  ohlcv: "Serie de velas con Open-High-Low-Close-Volume.",
  prices: "Secuencia de precios (spot o perp) en ticks/velas, útil para spreads.",
  bba: "Best Bid/Ask (mejor postor y oferente) con sus volúmenes.",
  book_delta: "Variaciones por nivel del libro entre dos snapshots consecutivos.",
  trades: "Historial de operaciones ejecutadas (agresivas).",
  spot: "Precio de mercado spot.",
  perp: "Precio de futuros perpetuos.",
  funding: "Historial de tasas de financiamiento de los perpetuos.",
  features: "Indicadores y estadísticas usados por un modelo de ML.",
};

let strategyInfo = {};

  async function loadStrategies(){
    try{
      const r = await fetch(api('/strategies/status'));
      const j = await r.json();
      const sel = document.getElementById('bot-strategy');
      sel.innerHTML='';
      Object.keys(j.strategies || {}).forEach(s=>{
        const o=document.createElement('option');
        o.value=s; o.textContent=s; sel.appendChild(o);
      });
    updateForm();
    }catch(e){}
  }

async function loadStrategyParams(name){
  const container=document.getElementById('bot-strategy-params');
  container.innerHTML='';
  const card=document.getElementById('bot-param-card');
  card.style.display='none';
  const toggle=document.getElementById('bot-toggle-params');
  toggle.checked=false;
  const field=document.getElementById('field-toggle-params');
  field.style.display='none';

  try{
    const r=await fetch(api(`/strategies/${name}/schema`));
    const j=await r.json();
    const params=(j.params||[]).filter(p=>p.name!=='config_path');
    field.style.display=params.length?'':'none';

    if(!params.length){
      document.getElementById('bot-output').textContent='No se pudieron cargar los parámetros';
      return;
    }

    params.forEach(p=>{
      const div=document.createElement('div');

      const label=document.createElement('label');
      label.htmlFor=`bot-param-${p.name}`;
      label.textContent=p.name;

      // siempre mostramos help-icon (aunque esté vacío, igual que en backtest)
      const help=document.createElement('span');
      help.className='help-icon';
      help.title=p.desc||'';
      help.textContent='?';
      label.appendChild(help);

      const input=document.createElement('input');
      input.className='param-input';
      input.id=`bot-param-${p.name}`;
      input.dataset.name=p.name;
      input.dataset.type=p.type||'';

      const type=(p.type||'').toLowerCase();
      if(type.includes('int')||type.includes('float')||type.includes('number')){
        input.type='number';
        input.step='0.0001';
      }else{
        input.type='text';
      }

      if(p.default!==undefined && p.default!==null) input.value=p.default;

      div.appendChild(label);
      div.appendChild(input);
      container.appendChild(div);
    });
  }catch(e){
    document.getElementById('bot-output').textContent=String(e);
  }
}


async function loadStrategyInfo(){
  try{
    const r=await fetch(api('/strategies/info'));
    strategyInfo=await r.json();
  }catch(e){
    console.error(e);
    strategyInfo={};
  }
  updateStrategyInfo();
}

function updateStrategyInfo(){
  const sel=document.getElementById('bot-strategy');
  const info=strategyInfo[sel.value]||{};
  const el=document.getElementById('bot-strategy-info');
  if(info.desc){
    let html=`<p>${info.desc}</p>`;
    if(info.requires && info.requires.length){
      html += "<p>Datos necesarios:</p><ul>" +
              info.requires.map(r => `<li><strong>${r}</strong>: ${dataInfo[r]}</li>`).join("") +
              "</ul>";
    }
    el.innerHTML = html;
  }else{
    el.textContent='';
  }
}

  function updateMarketFields(){
    const market=document.getElementById('bot-market').value;
    const strat=document.getElementById('bot-strategy').value;
    const cross=strat==='cross_arbitrage';
    const lev=document.getElementById('field-leverage');
    lev.style.display = (!cross && market==='futures') ? '' : 'none';
  }

  async function updateForm(){
    const strat=document.getElementById('bot-strategy').value;
    const cross=strat==='cross_arbitrage';
    ['field-exchange','field-market','field-risk-pct'].forEach(id=>{
      document.getElementById(id).style.display = cross ? 'none' : '';
    });
    ['field-spot','field-perp','field-threshold'].forEach(id=>{
      document.getElementById(id).style.display = cross ? '' : 'none';
    });
    await loadStrategyParams(strat);
    updateStrategyInfo();
    updateMarketFields();
  }

async function startBot(){
  const strategy = document.getElementById('bot-strategy').value;
  const pairs = document.getElementById('bot-pairs').value.split(',').map(s=>s.trim()).filter(Boolean);
  const exchange = document.getElementById('bot-exchange').value;
  const market = document.getElementById('bot-market').value;
  const risk_pct = document.getElementById('bot-risk-pct').value;
  const daily_max_loss_pct = document.getElementById('bot-daily-max-loss-pct').value;
  const daily_max_drawdown_pct = document.getElementById('bot-daily-max-drawdown-pct').value;
  const leverage = document.getElementById('bot-leverage').value;
  const env = document.getElementById('bot-env').value;
  const testnet = env === 'testnet';
  const dry_run = env === 'paper';
  const config = document.getElementById('bot-config').value;
    const spot = document.getElementById('bot-spot').value;
    const perp = document.getElementById('bot-perp').value;
    const threshold = document.getElementById('bot-threshold').value;
  const paramEls=document.querySelectorAll('#bot-strategy-params input');
    const params={};
    paramEls.forEach(el=>{
      if(!el.value) return;
      const t=(el.dataset.type||'').toLowerCase();
      let v=el.value;
      if(t.includes('int')) v=parseInt(v,10);
      else if(t.includes('float') || t.includes('number')) v=parseFloat(v);
      params[el.dataset.name]=v;
    });
    const payload = {strategy, pairs, exchange, market, testnet, dry_run};
    if(config) payload.config = config;
    if(risk_pct) payload.risk_pct = Number(risk_pct);
    if(daily_max_loss_pct) payload.daily_max_loss_pct = Number(daily_max_loss_pct);
    if(daily_max_drawdown_pct) payload.daily_max_drawdown_pct = Number(daily_max_drawdown_pct);
    if(leverage) payload.leverage = Number(leverage);
  if(strategy==='cross_arbitrage'){
    payload.spot = spot;
      payload.perp = perp;
      if(threshold) payload.threshold = Number(threshold);
    }
    if(Object.keys(params).length){
      try{ await fetch(api(`/strategies/${strategy}/params`), {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(params)}); }catch(e){}
    }
    try{
      const r = await fetch(api('/bots'), {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      const j = await r.json();
      document.getElementById('bot-output').textContent = JSON.stringify(j,null,2);
      refreshBots();
  }catch(e){ document.getElementById('bot-output').textContent = String(e); }
}

async function refreshBots(){
  try{
    const r = await fetch(api('/bots'));
    const j = await r.json();
    const body = document.querySelector('#tbl-bots tbody');
    body.innerHTML='';
    (j.bots||[]).forEach(b=>{
      const stats=b.stats||{};
      const pairs=(b.config?.pairs||[]).join(',');
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${b.pid}</td><td>${b.config?.strategy||''}</td><td>${pairs}</td><td>${b.status}</td>
      <td>${stats.orders_sent||0}/${stats.fills||0}</td>
      <td>${((stats.cancel_ratio||0)*100).toFixed(1)}%</td>
      <td>${(stats.maker_taker_ratio||0).toFixed(2)}</td>
      <td>${(stats.fees_usd||0).toFixed(2)}</td>
      <td>${(stats.slippage_bps||0).toFixed(2)}</td>
      <td>${((stats.hit_rate||0)*100).toFixed(1)}%</td>
      <td>${(stats.avg_trade_duration||0).toFixed(1)}</td>
      <td>${(stats.inventory||0).toFixed(4)}</td>
      <td>${(stats.leverage||0).toFixed(2)}</td>
      <td>${stats.risk_triggers||0}</td>
      <td>${b.last_error||''}</td>
      <td>
  <button class="icon-btn" onclick="pauseBot(${b.pid})" title="Pause">
    <i class="fa-solid fa-pause"></i>
  </button>
  <button class="icon-btn" onclick="resumeBot(${b.pid})" title="Resume">
    <i class="fa-solid fa-play"></i>
  </button>
  <button class="icon-btn warn" onclick="haltBot(${b.pid})" title="Halt">
    <i class="fa-solid fa-hand"></i>
  </button>
  <button class="icon-btn danger" onclick="flattenBot(${b.pid})" title="Flatten">
    <i class="fa-solid fa-bomb"></i>
  </button>
  <button class="icon-btn" onclick="reloadBot(${b.pid})" title="Reload">
    <i class="fa-solid fa-rotate-right"></i>
  </button>
  <button class="icon-btn" onclick="stopBot(${b.pid})" title="Stop">
    <i class="fa-solid fa-stop"></i>
  </button>
  <button class="icon-btn danger" onclick="deleteBot(${b.pid})" title="Delete">
    <i class="fa-solid fa-trash"></i>
  </button>
</td>
`;
      body.appendChild(tr);
    });
  }catch(e){}
}

async function runCli(){
  const cmd = document.getElementById('cli-input').value;
  if(!cmd.trim()) return;
  try{
    const r = await fetch(api('/cli/run'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({command: cmd})});
    const j = await r.json();
    const out = (j.stdout||'') + (j.stderr ? '\n'+j.stderr : '');
    document.getElementById('cli-output').textContent = out;
  }catch(e){
    document.getElementById('cli-output').textContent = String(e);
  }
}

async function stopBot(pid){ await fetch(api(`/bots/${pid}/stop`), {method:'POST'}); refreshBots(); }
async function pauseBot(pid){ await fetch(api(`/bots/${pid}/pause`), {method:'POST'}); refreshBots(); }
async function resumeBot(pid){ await fetch(api(`/bots/${pid}/resume`), {method:'POST'}); refreshBots(); }
async function deleteBot(pid){ await fetch(api(`/bots/${pid}`), {method:'DELETE'}); refreshBots(); }
async function haltBot(pid){ await fetch(api(`/bots/${pid}/halt`), {method:'POST'}); refreshBots(); }
async function flattenBot(pid){ await fetch(api(`/bots/${pid}/flatten`), {method:'POST'}); refreshBots(); }
async function reloadBot(pid){ await fetch(api(`/bots/${pid}/reload`), {method:'POST'}); refreshBots(); }

async function refreshRisk(){
  try{
    const ex = await fetch(api('/risk/exposure'));
    const exj = await ex.json();
    const ev = await fetch(api('/risk/events?limit=20'));
    const evj = await ev.json();
    document.getElementById('risk-output').textContent = JSON.stringify({exposure: exj, events: evj.items||evj.events||[]}, null,2);
  }catch(e){
    document.getElementById('risk-output').textContent = String(e);
  }
}

async function haltRisk(){
  try{
    await fetch(api('/risk/halt'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reason:'dashboard'})});
    refreshRisk();
  }catch(e){
    document.getElementById('risk-output').textContent = String(e);
  }
}

async function resetRisk(){
  try{
    await fetch(api('/risk/reset'), {method:'POST'});
    refreshRisk();
  }catch(e){
    document.getElementById('risk-output').textContent = String(e);
  }
}

document.getElementById('bot-start').addEventListener('click', startBot);
document.getElementById('bot-strategy').addEventListener('change', updateForm);
document.getElementById('bot-market').addEventListener('change', updateMarketFields);
document.getElementById('bot-toggle-params').addEventListener('change', e => {
  document.getElementById('bot-param-card').style.display = e.target.checked ? 'block' : 'none';
});
loadStrategies();
loadStrategyInfo();
updateMarketFields();
refreshBots();
setInterval(refreshBots,5000);
document.getElementById('cli-run').addEventListener('click', runCli);
document.getElementById('risk-refresh').addEventListener('click', refreshRisk);
document.getElementById('risk-halt').addEventListener('click', haltRisk);
document.getElementById('risk-reset').addEventListener('click', resetRisk);
refreshRisk();
</script>
</body>
</html>

