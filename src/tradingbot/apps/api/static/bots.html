<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Bots - TradingBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; background:#0b0f14; color:#e8eef5; }
    h1, h2 { margin: 0.2rem 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background:#121826; border:1px solid #1f2937; border-radius:12px; padding:14px; box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
    table { width:100%; border-collapse: collapse; font-size: 14px; }
    th, td { border-bottom: 1px solid #1f2937; padding: 8px 6px; text-align: left; }
    th { background:#0f1622; position: sticky; top:0; }
    .grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .muted { color:#94a3b8; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    button { background:#2563eb; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    button:hover { background:#1d4ed8; }
    input, select { width:100%; background:#0f1622; border:1px solid #1f2937; border-radius:8px; color:#e8eef5; padding:8px; font-family:inherit; }
    label { font-size:12px; color:#94a3b8; display:block; margin-top:8px; margin-bottom:4px; }
    nav { margin-bottom:20px; text-align:center; }
    nav a { color:#e8eef5; margin-right:15px; text-decoration:none; }
    nav a:hover { text-decoration:underline; }
    .logo { height:80px; display:block; margin:0 auto 20px; }
    pre { background:#0f1622; padding:10px; border-radius:8px; overflow:auto; }
  </style>
</head>
<body>
  <img src="/static/logo.png" alt="DMI Bot Trading" class="logo"/>
  <nav>
    <a href="/">Monitoreo</a>
    <a href="/bots">Bots</a>
    <a href="/stats">Estadísticas operativas</a>
  </nav>
  <h1>Bots</h1>

  <div class="card">
    <h2>Nuevo bot</h2>
    <div class="grid3" style="margin-top:10px">
      <div>
        <label for="bot-strategy">Estrategia</label>
        <select id="bot-strategy"></select>
      </div>
      <div>
        <label for="bot-pairs">Pares (coma)</label>
        <input id="bot-pairs" placeholder="BTC/USDT,ETH/USDT"/>
      </div>
      <div>
        <label for="bot-notional">Notional (USDT)</label>
        <input id="bot-notional" type="number" step="0.01"/>
      </div>
      <div>
        <label for="bot-exchange">Exchange</label>
        <select id="bot-exchange">
          <option value="binance">Binance</option>
          <option value="bybit">Bybit</option>
          <option value="okx">OKX</option>
        </select>
      </div>
      <div>
        <label for="bot-market">Mercado</label>
        <select id="bot-market">
          <option value="spot">Spot</option>
          <option value="futures">Futuros</option>
        </select>
      </div>
      <div>
        <label for="bot-trade-qty">Trade qty</label>
        <input id="bot-trade-qty" type="number" step="0.0001"/>
      </div>
      <div>
        <label for="bot-leverage">Leverage</label>
        <input id="bot-leverage" type="number" step="1"/>
      </div>
      <div>
        <label for="bot-env">Entorno</label>
        <select id="bot-env">
          <option value="live">Live</option>
          <option value="paper">Paper trading</option>
          <option value="testnet" selected>Testnet</option>
        </select>
      </div>
    </div>
    <button id="bot-start" style="margin-top:10px">Start</button>
    <pre id="bot-output" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Bots activos</h2>
    <div class="muted">Auto-refresh 5s</div>
    <div style="overflow:auto; max-height:60vh; margin-top:10px">
      <table id="tbl-bots">
        <thead><tr><th>PID</th><th>Estrategia</th><th>Pares</th><th>Estado</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Comandos CLI</h2>
    <div class="muted">Ejecuta cualquier comando de <code>tradingbot.cli</code></div>
    <input id="cli-input" class="mono" placeholder="--help"/>
    <button id="cli-run" style="margin-top:8px">Ejecutar</button>
    <pre id="cli-output" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Gestión de riesgo</h2>
    <div class="muted">Consultar exposiciones y eventos o ejecutar acciones</div>
    <button id="risk-refresh">Consultar</button>
    <button id="risk-halt">Halt</button>
    <button id="risk-reset">Reset</button>
    <pre id="risk-output" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

<script>
const api = (path) => `${location.origin}${path}`;

async function loadStrategies(){
  try{
    const r = await fetch(api('/strategies/status'));
    const j = await r.json();
    const sel = document.getElementById('bot-strategy');
    sel.innerHTML='';
    Object.keys(j.strategies || {}).forEach(s=>{
      const o=document.createElement('option');
      o.value=s; o.textContent=s; sel.appendChild(o);
    });
  }catch(e){}
}

async function startBot(){
  const strategy = document.getElementById('bot-strategy').value;
  const pairs = document.getElementById('bot-pairs').value.split(',').map(s=>s.trim()).filter(Boolean);
  const notional = document.getElementById('bot-notional').value;
  const exchange = document.getElementById('bot-exchange').value;
  const market = document.getElementById('bot-market').value;
  const trade_qty = document.getElementById('bot-trade-qty').value;
  const leverage = document.getElementById('bot-leverage').value;
  const env = document.getElementById('bot-env').value;
  const testnet = env === 'testnet';
  const dry_run = env === 'paper';
  const payload = {strategy, pairs, exchange, market, testnet, dry_run};
  if(notional) payload.notional = Number(notional);
  if(trade_qty) payload.trade_qty = Number(trade_qty);
  if(leverage) payload.leverage = Number(leverage);
  try{
    const r = await fetch(api('/bots'), {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    const j = await r.json();
    document.getElementById('bot-output').textContent = JSON.stringify(j,null,2);
    refreshBots();
  }catch(e){ document.getElementById('bot-output').textContent = String(e); }
}

async function refreshBots(){
  try{
    const r = await fetch(api('/bots'));
    const j = await r.json();
    const body = document.querySelector('#tbl-bots tbody');
    body.innerHTML='';
    (j.bots||[]).forEach(b=>{
      const tr=document.createElement('tr');
      const pairs=(b.config?.pairs||[]).join(',');
      tr.innerHTML=`<td>${b.pid}</td><td>${b.config?.strategy||''}</td><td>${pairs}</td><td>${b.status}</td>
      <td>
        <button onclick="stopBot(${b.pid})">Stop</button>
        <button onclick="pauseBot(${b.pid})">Pause</button>
        <button onclick="resumeBot(${b.pid})">Resume</button>
        <button onclick="deleteBot(${b.pid})">Delete</button>
      </td>`;
      body.appendChild(tr);
    });
  }catch(e){}
}

async function runCli(){
  const cmd = document.getElementById('cli-input').value;
  if(!cmd.trim()) return;
  try{
    const r = await fetch(api('/cli/run'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({command: cmd})});
    const j = await r.json();
    const out = (j.stdout||'') + (j.stderr ? '\n'+j.stderr : '');
    document.getElementById('cli-output').textContent = out;
  }catch(e){
    document.getElementById('cli-output').textContent = String(e);
  }
}

async function stopBot(pid){ await fetch(api(`/bots/${pid}/stop`), {method:'POST'}); refreshBots(); }
async function pauseBot(pid){ await fetch(api(`/bots/${pid}/pause`), {method:'POST'}); refreshBots(); }
async function resumeBot(pid){ await fetch(api(`/bots/${pid}/resume`), {method:'POST'}); refreshBots(); }
async function deleteBot(pid){ await fetch(api(`/bots/${pid}`), {method:'DELETE'}); refreshBots(); }

async function refreshRisk(){
  try{
    const ex = await fetch(api('/risk/exposure'));
    const exj = await ex.json();
    const ev = await fetch(api('/risk/events?limit=20'));
    const evj = await ev.json();
    document.getElementById('risk-output').textContent = JSON.stringify({exposure: exj, events: evj.items||evj.events||[]}, null,2);
  }catch(e){
    document.getElementById('risk-output').textContent = String(e);
  }
}

async function haltRisk(){
  try{
    await fetch(api('/risk/halt'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reason:'dashboard'})});
    refreshRisk();
  }catch(e){
    document.getElementById('risk-output').textContent = String(e);
  }
}

async function resetRisk(){
  try{
    await fetch(api('/risk/reset'), {method:'POST'});
    refreshRisk();
  }catch(e){
    document.getElementById('risk-output').textContent = String(e);
  }
}

document.getElementById('bot-start').addEventListener('click', startBot);
loadStrategies();
refreshBots();
setInterval(refreshBots,5000);
document.getElementById('cli-run').addEventListener('click', runCli);
document.getElementById('risk-refresh').addEventListener('click', refreshRisk);
document.getElementById('risk-halt').addEventListener('click', haltRisk);
document.getElementById('risk-reset').addEventListener('click', resetRisk);
refreshRisk();
</script>
</body>
</html>

