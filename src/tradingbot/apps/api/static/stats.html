<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Estadísticas - TradingBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; background:#0b0f14; color:#e8eef5; }
    h1, h2 { margin: 0.2rem 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background:#121826; border:1px solid #1f2937; border-radius:12px; padding:14px; box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
    table { width:100%; border-collapse: collapse; font-size: 14px; }
    th, td { border-bottom: 1px solid #1f2937; padding: 8px 6px; text-align: left; }
    th { background:#0f1622; position: sticky; top:0; }
    .muted { color:#94a3b8; }
    .grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .kv { background:#0f1622; border:1px solid #1f2937; border-radius:10px; padding:10px; }
    .kv .k { font-size:12px; color:#94a3b8 }
    .kv .v { font-size:18px; margin-top:4px }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    nav { margin-bottom:20px; text-align:center; }
    nav a { color:#e8eef5; margin-right:15px; text-decoration:none; }
    nav a:hover { text-decoration:underline; }
    .logo { height:80px; display:block; margin:0 auto 20px; }
  </style>
</head>
<body>
<header class="center" style="margin-bottom:8px">
  <img src="/static/logo.png" alt="DMI Bot Trading" class="logo">
  <nav>
    <a href="/">Monitoreo</a>
    <a href="/bots">Bots</a>
    <a href="/stats">Estadísticas operativas</a>
  </nav>
</header>

  <h1>Estadísticas operativas</h1>
  <div class="grid3" style="margin:14px 0 20px">
    <div class="kv"><div class="k">PnL</div><div class="v" id="m-pnl">—</div></div>
    <div class="kv"><div class="k">Fills</div><div class="v" id="m-fills">—</div></div>
    <div class="kv"><div class="k">Risk Events</div><div class="v" id="m-risk">—</div></div>
  </div>
  <div class="card">
    <h2>Filtros</h2>
    <div class="grid3" style="margin-top:10px">
      <div>
        <label for="fl-symbol">Símbolo</label>
        <input id="fl-symbol" placeholder="BTCUSDT"/>
      </div>
      <div style="display:flex;align-items:end;">
        <button id="fl-apply">Aplicar</button>
      </div>
    </div>
  </div>  
  <div class="row" style="margin-top:20px">
    <div class="card">
      <h2>PnL Spot (6h)</h2>
      <canvas id="chart-pnl-spot" height="120"></canvas>
    </div>
    <div class="card">
      <h2>PnL Futuros (6h)</h2>
      <canvas id="chart-pnl-fut" height="120"></canvas>
    </div>
  </div>
  <div class="card" style="margin-top:16px">
      <h2>PnL por símbolo (Spot)</h2>
      <div class="muted">Realizado, no realizado y neto</div>
      <div style="overflow:auto; max-height: 40vh; margin-top:10px">
        <table id="tbl-pnl-spot">
          <thead><tr><th>symbol</th><th>qty</th><th>avg</th><th>UPnL</th><th>RPnL</th><th>fees</th><th>net</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>PnL por símbolo (Futuros)</h2>
      <div class="muted">Realizado, no realizado y neto</div>
      <div style="overflow:auto; max-height: 40vh; margin-top:10px">
        <table id="tbl-pnl-fut">
          <thead><tr><th>symbol</th><th>qty</th><th>avg</th><th>UPnL</th><th>RPnL</th><th>fees</th><th>net</th></tr></thead>
          <tbody></tbody>
        </table>
    </div>
  </div>
  <div class="card" style="margin-top:16px">
    <h2>Fills por estrategia y símbolo</h2>
    <div style="overflow:auto; max-height: 40vh; margin-top:10px">
      <table id="tbl-fills-summary">
        <thead><tr><th>venue</th><th>strategy</th><th>symbol</th><th>fills</th><th>notional</th><th>fees</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div class="card" style="margin-top:20px">
    <h2>Posiciones</h2>
    <div style="overflow:auto; max-height:60vh; margin-top:10px">
      <table id="tbl-pos">
        <thead><tr><th>Symbol</th><th>Position</th><th>Funding</th><th>Basis</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
<script>
async function refreshMetrics(){
  try{
    const r = await fetch('/metrics');
    const j = await r.json();
    document.getElementById('m-pnl').textContent = (j.pnl||0).toFixed(2);
    document.getElementById('m-fills').textContent = j.fills||0;
    document.getElementById('m-risk').textContent = j.risk_events||0;
  }catch(e){}
}
async function refreshPositions(){
  try{
    const r = await fetch('/metrics/positions');
    const j = await r.json();
    const body = document.querySelector('#tbl-pos tbody');
    body.innerHTML='';
    const pos=j.positions||{}; const fund=j.funding_rates||{}; const basis=j.basis||{};
    Object.keys(pos).forEach(sym=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${sym}</td><td>${pos[sym].toFixed(4)}</td><td>${(fund[sym]||0).toFixed(4)}</td><td>${(basis[sym]||0).toFixed(4)}</td>`;
      body.appendChild(tr);
    });
  }catch(e){}
}
let currentSymbol='';
function buildPnlChart(ctx, labels, upnl, rpnl, net){
  new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'UPnL',data:upnl,borderColor:'#10b981'},{label:'RPnL',data:rpnl,borderColor:'#3b82f6'},{label:'Net',data:net,borderColor:'#f59e0b'}]},options:{responsive:true,animation:false,interaction:{mode:'index',intersect:false},scales:{x:{grid:{display:false}},y:{beginAtZero:false}}}});
}
async function refreshPnlSpot(){
  try{
    const sym=currentSymbol?`&symbol=${currentSymbol}`:'';
    const r=await fetch(`/pnl/timeseries?venue=binance_spot_testnet&bucket=1%20minute&hours=6${sym}`);
    const j=await r.json();
    const pts=j.points||[]; const labels=pts.map(p=>p.ts.replace('T',' ').replace('Z',''));
    const upnl=pts.map(p=>p.upnl||0); const rpnl=pts.map(p=>p.rpnl||0); const net=pts.map(p=>p.net||0);
    buildPnlChart(document.getElementById('chart-pnl-spot').getContext('2d'),labels,upnl,rpnl,net);
  }catch(e){}
}
async function refreshPnlFut(){
  try{
    const sym=currentSymbol?`&symbol=${currentSymbol}`:'';
    const r=await fetch(`/pnl/timeseries?venue=binance_futures_um_testnet&bucket=1%20minute&hours=6${sym}`);
    const j=await r.json();
    const pts=j.points||[]; const labels=pts.map(p=>p.ts.replace('T',' ').replace('Z',''));
    const upnl=pts.map(p=>p.upnl||0); const rpnl=pts.map(p=>p.rpnl||0); const net=pts.map(p=>p.net||0);
    buildPnlChart(document.getElementById('chart-pnl-fut').getContext('2d'),labels,upnl,rpnl,net);
  }catch(e){}
}
async function refreshPnlSummarySpot(){
  try{
    const sym=currentSymbol?`&symbol=${currentSymbol}`:'';
    const r=await fetch(`/pnl/summary?venue=binance_spot_testnet${sym}`);
    const j=await r.json();
    const body=document.querySelector('#tbl-pnl-spot tbody');
    body.innerHTML='';
    (j.items||[]).forEach(it=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${it.symbol}</td><td>${Number(it.qty).toFixed(4)}</td><td>${Number(it.avg_price).toFixed(4)}</td><td>${Number(it.upnl||0).toFixed(2)}</td><td>${Number(it.realized_pnl||0).toFixed(2)}</td><td>${Number(it.fees_paid||0).toFixed(2)}</td><td>${Number(it.total_pnl||0).toFixed(2)}</td>`;
      body.appendChild(tr);
    });
  }catch(e){}
}
async function refreshPnlSummaryFut(){
  try{
    const sym=currentSymbol?`&symbol=${currentSymbol}`:'';
    const r=await fetch(`/pnl/summary?venue=binance_futures_um_testnet${sym}`);
    const j=await r.json();
    const body=document.querySelector('#tbl-pnl-fut tbody');
    body.innerHTML='';
    (j.items||[]).forEach(it=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${it.symbol}</td><td>${Number(it.qty).toFixed(4)}</td><td>${Number(it.avg_price).toFixed(4)}</td><td>${Number(it.upnl||0).toFixed(2)}</td><td>${Number(it.realized_pnl||0).toFixed(2)}</td><td>${Number(it.fees_paid||0).toFixed(2)}</td><td>${Number(it.total_pnl||0).toFixed(2)}</td>`;
      body.appendChild(tr);
    });
  }catch(e){}
}
async function refreshFillsSummary(){
  try{
    const sym=currentSymbol?`&symbol=${currentSymbol}`:'';
    const venues=['binance_spot_testnet','binance_futures_um_testnet'];
    const body=document.querySelector('#tbl-fills-summary tbody');
    body.innerHTML='';
    for(const v of venues){
      const r=await fetch(`/fills/summary?venue=${v}${sym}`);
      const j=await r.json();
      (j.items||[]).forEach(it=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${v}</td><td>${it.strategy}</td><td>${it.symbol}</td><td>${it.fills}</td><td>${Number(it.notional||0).toFixed(2)}</td><td>${Number(it.fees||0).toFixed(2)}</td>`;
        body.appendChild(tr);
      });
    }
  }catch(e){}
}
function applyFilters(){
  currentSymbol=document.getElementById('fl-symbol').value.trim();
  refreshPnlSpot();
  refreshPnlFut();
  refreshPnlSummarySpot();
  refreshPnlSummaryFut();
  refreshFillsSummary();
}
refreshMetrics();
refreshPositions();
refreshPnlSpot();
refreshPnlFut();
refreshPnlSummarySpot();
refreshPnlSummaryFut();
refreshFillsSummary();
setInterval(refreshMetrics,5000);
setInterval(refreshPositions,5000);
setInterval(refreshPnlSpot,10000);
setInterval(refreshPnlFut,10000);
setInterval(refreshPnlSummarySpot,10000);
setInterval(refreshPnlSummaryFut,10000);
setInterval(refreshFillsSummary,10000);
document.getElementById('fl-apply').addEventListener('click',applyFilters);
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</body>
</html>
