<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>TradingBot Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/styles.css"/>
  </head>
  <body>
  <nav>
    <a href="/">Configuración</a>
    <a href="/monitor">Monitoreo</a>
    <a href="/bots">Bots</a>
  </nav>
  <h1>TradingBot Dashboard</h1>
  <div class="muted" id="health">Comprobando estado…</div>

  <div class="card" style="margin-top:16px">
    <h2>Configuración</h2>
    <div class="muted">Configura las credenciales del exchange sin usar la CLI</div>
    <div class="grid3" style="margin-top:10px">
      <div>
        <label for="cfg-exchange">Exchange</label>
        <select id="cfg-exchange">
          <option value="binance_spot">Binance Spot</option>
          <option value="binance_futures_um">Binance Futuros</option>
          <option value="bybit_spot">Bybit Spot</option>
          <option value="okx_spot">OKX Spot</option>
        </select>
      </div>
      <div>
        <label for="cfg-key">API Key</label>
        <input id="cfg-key" placeholder="clave"/>
      </div>
      <div>
        <label for="cfg-secret">API Secret</label>
        <input id="cfg-secret" type="password" placeholder="secreto"/>
      </div>
    </div>
    <button id="cfg-save" style="margin-top:10px">Guardar configuración</button>
    <pre id="cfg-output" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

  <div class="grid3" style="margin:14px 0 20px">
    <div class="kv"><div class="k">Señales (últimas)</div><div class="v" id="sum-count">—</div></div>
    <div class="kv"><div class="k">Edge promedio</div><div class="v" id="sum-avg-edge">—</div></div>
    <div class="kv"><div class="k">Último evento riesgo</div><div class="v" id="sum-risk-last">—</div></div>
    <div class="kv"><div class="k">Notional promedio (QUOTE)</div><div class="v" id="sum-avg-notional">—</div></div>
    <div class="kv"><div class="k">Exposición total (Spot)</div><div class="v" id="sum-expo-spot">—</div></div>
    <div class="kv"><div class="k">Exposición total (Futuros)</div><div class="v" id="sum-expo-fut">—</div></div>
    <div class="kv"><div class="k">UPnL (Spot)</div><div class="v" id="sum-upnl-spot">—</div></div>
    <div class="kv"><div class="k">RPnL (Spot)</div><div class="v" id="sum-rpnl-spot">—</div></div>
    <div class="kv"><div class="k">PnL Neto (Spot)</div><div class="v" id="sum-net-spot">—</div></div>
    <div class="kv"><div class="k">UPnL (Futuros)</div><div class="v" id="sum-upnl-fut">—</div></div>
    <div class="kv"><div class="k">RPnL (Futuros)</div><div class="v" id="sum-rpnl-fut">—</div></div>
    <div class="kv"><div class="k">PnL Neto (Futuros)</div><div class="v" id="sum-net-fut">—</div></div>
  </div>


  <div class="row">
    <div class="card">
      <h2>Señales Triangulares</h2>
      <div class="muted">Auto‑refresh 5s</div>
      <div style="overflow:auto; max-height: 60vh; margin-top:10px">
        <table id="tbl-signals">
          <thead>
            <tr>
              <th>ts</th><th>paridad</th><th>dir</th><th>edge</th><th>notional</th><th>bq</th><th>mq</th><th>mb</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>Historial de Órdenes</h2>
      <div class="muted">Auto‑refresh 5s</div>
      <input id="order-search" placeholder="buscar…" style="margin-top:8px"/>
      <div style="overflow:auto; max-height: 60vh; margin-top:10px">
        <table id="tbl-orders">
          <thead>
            <tr>
              <th>ts</th><th>strategy</th><th>symbol</th><th>side</th><th>qty</th><th>px</th><th>status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Eventos de riesgo (Spot)</h2>
      <div class="muted">Últimos 20</div>
      <div style="overflow:auto; max-height: 40vh; margin-top:10px">
        <table id="tbl-risk-events">
          <thead><tr><th>ts</th><th>kind</th><th>symbol</th><th>message</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Exposición por símbolo (Spot)</h2>
      <div class="muted">Último snapshot por símbolo</div>
      <div style="overflow:auto; max-height: 40vh; margin-top:10px">
        <table id="tbl-expo-spot">
          <thead><tr><th>symbol</th><th>position</th><th>px</th><th>notional</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Exposición por símbolo (Futuros)</h2>
      <div class="muted">Último snapshot por símbolo</div>
      <div style="overflow:auto; max-height: 40vh; margin-top:10px">
        <table id="tbl-expo-fut">
          <thead><tr><th>symbol</th><th>position</th><th>px</th><th>notional</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Logs</h2>
    <div class="muted">Auto‑refresh 5s</div>
    <pre id="logs" class="mono" style="overflow:auto; max-height:60vh; background:#0f1622; padding:10px"></pre>
  </div>
</div>
<script>
const api = (path) => `${location.origin}${path}`;
let orderQuery = "";

function fmtEdge(x){ if(x==null) return "—"; return (x*100).toFixed(3)+"%"; }
function fmtNum(x, d=6){ if(x==null) return "—"; const n=Number(x); return isFinite(n)? n.toFixed(d): x; }
function fmtUSD(x){ if(x==null) return "—"; const n=Number(x); if(!isFinite(n)) return x; return n.toLocaleString(undefined,{maximumFractionDigits:2}); }

async function refreshHealth(){
  try {
    const r = await fetch(api("/health"));
    const j = await r.json();
    const s = j.status === "ok" ? `<span class="ok">OK</span>` : `<span class="warn">WARN</span>`;
    const db = j.db ? `<span class="ok">DB</span>` : `<span class="warn">no DB</span>`;
    document.getElementById("health").innerHTML = `Estado: ${s} · ${db}`;
  } catch (e) {
    document.getElementById("health").innerHTML = `<span class="warn">Sin conexión</span>`;
  }
}

async function refreshSummary(){
  try {
    const r = await fetch(api("/tri/summary?limit=200"));
    const j = await r.json();
    const s = j.summary || {};
    document.getElementById("sum-count").textContent = s.count ?? "0";
    document.getElementById("sum-avg-edge").textContent = fmtEdge(s.avg_edge);
    document.getElementById("sum-avg-notional").textContent = fmtNum(s.avg_notional, 2);
  } catch(e){}
}

function renderSignals(items){
  const tb = document.querySelector("#tbl-signals tbody");
  tb.innerHTML = "";
  for(const r of items){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${r.ts?.replace('T',' ').replace('Z','')}</td>
      <td>${r.base}/${r.mid}/${r.quote}</td>
      <td><span class="badge">${r.direction}</span></td>
      <td>${fmtEdge(r.edge)}</td>
      <td class="mono">${fmtNum(r.notional_quote,2)}</td>
      <td class="mono">${fmtNum(r.bq,2)}</td>
      <td class="mono">${fmtNum(r.mq,2)}</td>
      <td class="mono">${fmtNum(r.mb,6)}</td>
    `;
    tb.appendChild(tr);
  }
}

function renderOrders(items){
  const tb = document.querySelector("#tbl-orders tbody");
  tb.innerHTML = "";
  for(const r of items){
    const tr = document.createElement("tr");
    const sideCls = (r.side||"").toLowerCase()==="buy" ? "buy" : "sell";
    tr.innerHTML = `
      <td class="mono">${r.ts?.replace('T',' ').replace('Z','')}</td>
      <td>${r.strategy}</td>
      <td class="mono">${r.symbol}</td>
      <td class="${sideCls}">${r.side}</td>
      <td class="mono">${fmtNum(r.qty,6)}</td>
      <td class="mono">${fmtNum(r.px,4)}</td>
      <td>${r.status}</td>
    `;
    tb.appendChild(tr);
  }
}

async function refreshOrders(){
  try{
    const q = orderQuery ? `&search=${encodeURIComponent(orderQuery)}` : "";
    const r = await fetch(api(`/orders/history?limit=120${q}`));
    const j = await r.json();
    renderOrders(j.items || []);
  }catch(e){}
}

async function refreshTables(){
  try {
    const r1 = await fetch(api("/tri/signals?limit=100"));
    const j1 = await r1.json();
    renderSignals(j1.items || []);
  } catch(e){}
  refreshOrders();
}

async function refreshExposure(){
  try{
    const r = await fetch(api("/risk/exposure?venue=binance_spot_testnet"));
    const j = await r.json();
    document.getElementById("sum-expo-spot").textContent = "$ " + fmtUSD(j.total_notional || 0);
    const tb = document.querySelector("#tbl-expo-spot tbody");
    tb.innerHTML = "";
    for(const it of (j.items || [])){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.symbol}</td>
        <td class="mono">${fmtNum(it.position, 6)}</td>
        <td class="mono">${fmtNum(it.price, 2)}</td>
        <td class="mono">$ ${fmtUSD(it.notional_usd)}</td>
      `;
      tb.appendChild(tr);
    }
  }catch(e){}
}

async function refreshExposureFut(){
  try{
    const r = await fetch(api("/risk/exposure?venue=binance_futures_um_testnet"));
    const j = await r.json();
    document.getElementById("sum-expo-fut").textContent = "$ " + fmtUSD(j.total_notional || 0);
    const tb = document.querySelector("#tbl-expo-fut tbody");
    if(tb){
      tb.innerHTML = "";
      for(const it of (j.items || [])){
        const tr = document.createElement("tr");
        tr.innerHTML = `
        <td>${it.symbol}</td>
        <td class="mono">${fmtNum(it.position, 6)}</td>
        <td class="mono">${fmtNum(it.price, 2)}</td>
        <td class="mono">$ ${fmtUSD(it.notional_usd)}</td>
        `;
        tb.appendChild(tr);
      }
    }
  }catch(e){}
}

async function refreshRisk(){
  try{
    const r = await fetch(api("/risk/events?venue=binance_spot_testnet&limit=20"));
    const j = await r.json();
    const items = j.items || [];
    const tb = document.querySelector("#tbl-risk-events tbody");
    tb.innerHTML = "";
    for(const it of items){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${(it.ts||"").replace('T',' ').replace('Z','')}</td>
        <td>${it.kind}</td>
        <td>${it.symbol}</td>
        <td>${it.message}</td>
      `;
      tb.appendChild(tr);
    }
    // banner “último evento”
    if(items.length){
      const last = items[0];
      const label = `[${last.kind}] ${last.symbol} – ${last.message}`;
      document.getElementById("sum-risk-last").textContent = label;
    } else {
      document.getElementById("sum-risk-last").textContent = "—";
    }
  }catch(e){}
}



async function refreshLogs(){
  try{
    const r = await fetch(api("/logs?lines=200"));
    const j = await r.json();
    const pre = document.getElementById("logs");
    pre.textContent = (j.items || []).join("\n");
  }catch(e){}
}




  async function saveConfig(){
    const ex = document.getElementById("cfg-exchange").value;
    const key = document.getElementById("cfg-key").value.trim();
    const sec = document.getElementById("cfg-secret").value.trim();
    let output = "";
    if(key && sec){
      try{
        const r = await fetch(api("/cli/run"), {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({command: `secrets set ${ex} ${key} ${sec}`})
        });
        const j = await r.json();
        output += (j.stdout||"") + (j.stderr?"\n"+j.stderr:"");
      }catch(e){ output += String(e); }
    }
    if(!output) output = "Configuración guardada";
    document.getElementById("cfg-output").textContent = output;
  }
// boot
refreshHealth(); refreshSummary(); refreshTables();
setInterval(refreshExposure, 5000); refreshExposure();
setInterval(refreshExposureFut, 5000); refreshExposureFut();
setInterval(refreshRisk, 5000); refreshRisk();
setInterval(refreshLogs, 5000); refreshLogs();
setInterval(refreshHealth, 5000);
setInterval(refreshSummary, 5000);
setInterval(refreshTables, 5000);

  document.getElementById("cfg-save").addEventListener("click", saveConfig);
  document.getElementById("order-search").addEventListener("input", (e)=>{ orderQuery = e.target.value; refreshOrders(); });

  </script>
</body>
</html>
