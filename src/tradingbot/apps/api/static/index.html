<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <link rel="icon" href="/static/favicon.ico">
  <title>DMI - TradingBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/styles.css"/>
  <script src="/static/header.js" defer></script>
</head>
<body>
  <h1>Monitoreo</h1>
  <div class="muted" id="health">Comprobando estado…</div>
  <div class="grid5" style="margin:14px 0 10px">
    <div class="kv"><div class="k">Reject Rate</div><div class="v" id="m-reject">—</div></div>
    <div class="kv"><div class="k">Latency p90 (s)</div><div class="v" id="m-lat90">—</div></div>
    <div class="kv"><div class="k">Latency p99 (s)</div><div class="v" id="m-lat99">—</div></div>
    <div class="kv"><div class="k">WS Uptime %</div><div class="v" id="m-ws-up">—</div></div>
    <div class="kv"><div class="k">Reconex/hr</div><div class="v" id="m-ws-rec">—</div></div>
  </div>
  <div class="grid5" style="margin:0 0 10px">
    <div class="kv"><div class="k">Book Lag (ms)</div><div class="v" id="m-book-lag">—</div></div>
    <div class="kv"><div class="k">CPU %</div><div class="v" id="m-cpu">—</div></div>
    <div class="kv"><div class="k">Mem (MB)</div><div class="v" id="m-mem">—</div></div>
    <div class="kv"><div class="k">FDs</div><div class="v" id="m-fds">—</div></div>
    <div class="kv"><div class="k">Uptime (s)</div><div class="v" id="m-uptime">—</div></div>
  </div>
  <div class="grid5" style="margin:0 0 10px">
    <div class="kv"><div class="k">Ingest rate</div><div class="v" id="m-ingest">—</div></div>
    <div class="kv"><div class="k">Persist backlog</div><div class="v" id="m-backlog">—</div></div>
    <div class="kv"><div class="k">HTTP 4xx</div><div class="v" id="m-err-4xx">—</div></div>
    <div class="kv"><div class="k">HTTP 5xx</div><div class="v" id="m-err-5xx">—</div></div>
    <div class="kv"><div class="k">Timeouts</div><div class="v" id="m-err-timeout">—</div></div>
  </div>
  <div class="grid4" style="margin:0 0 10px">
    <div class="kv"><div class="k">Throttling</div><div class="v" id="m-err-throttle">—</div></div>
    <div class="kv"><div class="k">Auth Errors</div><div class="v" id="m-err-auth">—</div></div>
    <div class="kv"><div class="k">Spread</div><div class="v" id="m-spread">—</div></div>
    <div class="kv"><div class="k">Depth</div><div class="v" id="m-depth">—</div></div>
  </div>
  <div class="grid4" style="margin:0 0 20px">
    <div class="kv"><div class="k">Funding</div><div class="v" id="m-funding-now">—</div></div>
    <div class="kv"><div class="k">Próx Funding</div><div class="v" id="m-funding-next">—</div></div>
    <div class="kv"><div class="k">Basis</div><div class="v" id="m-basis">—</div></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Balances</h2>
    <table id="bal-table">
      <thead>
        <tr><th>Exchange</th><th>USDT</th><th>BTC</th></tr>
      </thead>
      <tbody id="bal-body"></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Tickers</h2>
    <table id="tick-table">
      <thead>
        <tr><th>Exchange</th><th>BTC/USDT</th><th>ETH/USDT</th><th>XRP/USDT</th></tr>
      </thead>
      <tbody id="tick-body"></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Credenciales</h2>
    <div class="grid3" style="margin-top:10px">
      <div>
        <label for="cfg-exchange">Exchange</label>
        <select id="cfg-exchange"></select>
      </div>
      <div>
        <label for="cfg-key">API Key</label>
        <input id="cfg-key" placeholder="clave"/>
      </div>
      <div>
        <label for="cfg-secret">API Secret</label>
        <input id="cfg-secret" type="password" placeholder="secreto"/>
      </div>
    </div>
    <button id="cfg-save" style="margin-top:10px">Guardar credenciales</button>
    <pre id="cfg-output" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Logs</h2>
    <pre id="logs" class="mono" style="overflow:auto; max-height:60vh"></pre>
  </div>

<script>
const api = (path) => `${location.origin}${path}`;
const allowedExchanges = [
  'binance_spot',
  'binance_futures',
  'binance_spot_testnet',
  'binance_futures_testnet',
  'okx_spot',
  'okx_spot_testnet',
  'okx_futures',
  'okx_futures_testnet',
  'bybit_spot',
  'bybit_spot_testnet',
  'bybit_futures',
  'bybit_futures_testnet',
];

function updateCredInputs(){
  const ex = document.getElementById('cfg-exchange').value;
  document.getElementById('cfg-key').value = localStorage.getItem('key:'+ex) || '';
  document.getElementById('cfg-secret').value = localStorage.getItem('secret:'+ex) || '';
}

async function loadExchanges(){
  try{
    const r = await fetch(api('/ccxt/exchanges?include_testnet=1'));
    const exchanges = await r.json();
    const sel = document.getElementById('cfg-exchange');
    sel.innerHTML = '';
    for(const ex of exchanges){
      if(!allowedExchanges.includes(ex)) continue;
      const opt = document.createElement('option');
      opt.value = ex;
      opt.textContent = ex;
      sel.appendChild(opt);
    }
    const last = localStorage.getItem('exchange');
    if(last && allowedExchanges.includes(last)){
      sel.value = last;
    }
    sel.addEventListener('change', () => {
      localStorage.setItem('exchange', sel.value);
      updateCredInputs();
    });
    updateCredInputs();
  }catch(e){
    console.error(e);
  }
}

async function refreshHealth(){
  try {
    const r = await fetch(api('/health'));
    const j = await r.json();
    const s = j.status === 'ok' ? '<span class="ok">OK</span>' : '<span class="warn">WARN</span>';
    const db = j.db ? '<span class="ok">DB</span>' : '<span class="warn">no DB</span>';
    document.getElementById('health').innerHTML = `Estado: ${s} · ${db}`;
  } catch(e){
    document.getElementById('health').innerHTML = '<span class="warn">Sin conexión</span>';
  }
}

async function refreshMetrics(){
  try{
    const r = await fetch(api('/metrics'));
    const j = await r.json();
    document.getElementById('m-reject').textContent = ((j.order_reject_rate||0)*100).toFixed(2)+'%';
    document.getElementById('m-ws-up').textContent = ((j.ws_uptime||0)*100).toFixed(2)+'%';
    document.getElementById('m-ws-rec').textContent = (j.ws_reconnections_per_hour||0).toFixed(2);
    document.getElementById('m-book-lag').textContent = (j.book_lag_ms||0).toFixed(1);
    document.getElementById('m-cpu').textContent = (j.cpu_percent||0).toFixed(1);
    document.getElementById('m-mem').textContent = ((j.memory_bytes||0)/1048576).toFixed(1);
    document.getElementById('m-fds').textContent = j.fd_count||0;
    document.getElementById('m-uptime').textContent = (j.process_uptime_seconds||0).toFixed(0);
    document.getElementById('m-ingest').textContent = (j.ingest_rate||0).toFixed(1);
    document.getElementById('m-backlog').textContent = j.persist_backlog||0;
    document.getElementById('m-err-4xx').textContent = j.errors_4xx||0;
    document.getElementById('m-err-5xx').textContent = j.errors_5xx||0;
    document.getElementById('m-err-timeout').textContent = j.errors_timeout||0;
    document.getElementById('m-err-throttle').textContent = j.errors_throttling||0;
    document.getElementById('m-err-auth').textContent = j.errors_auth||0;
    try{
      const l = await fetch(api('/metrics/latency'));
      const lj = await l.json();
      document.getElementById('m-lat90').textContent = (lj.p90||0).toFixed(3);
      document.getElementById('m-lat99').textContent = (lj.p99||0).toFixed(3);
    }catch(e){}
  }catch(e){}
}

async function refreshMarket(){
  try{
    const r = await fetch(api('/metrics/market'));
    const j = await r.json();
    document.getElementById('m-spread').textContent = (j.spread||0).toFixed(4);
    document.getElementById('m-depth').textContent = (j.depth||0).toFixed(0);
    document.getElementById('m-funding-now').textContent = (j.funding_current||0).toFixed(4);
    document.getElementById('m-funding-next').textContent = (j.funding_next||0).toFixed(4);
    document.getElementById('m-basis').textContent = (j.basis||0).toFixed(4);
    if(j.basis_alert){
      document.getElementById('m-basis').classList.add('warn');
    }else{
      document.getElementById('m-basis').classList.remove('warn');
  }
  }catch(e){}
}

async function refreshBalances(){
  const body=document.getElementById('bal-body');
  if(!body) return;
  body.innerHTML='';
  for(const ex of allowedExchanges){
    let usdt='—';
    let btc='—';
    try{
      const r=await fetch(api(`/balances/${ex}`));
      const j=await r.json();
      if(j && j.USDT!=null) usdt=Number(j.USDT).toFixed(2);
      if(j && j.BTC!=null) btc=Number(j.BTC).toFixed(6);
    }catch(e){}
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${ex}</td><td>${usdt}</td><td>${btc}</td>`;
    body.appendChild(tr);
  }
}

const tickerSymbols=['BTC/USDT','ETH/USDT','XRP/USDT'];

async function refreshTickers(){
  const body=document.getElementById('tick-body');
  if(!body) return;
  body.innerHTML='';
  for(const ex of allowedExchanges){
    let row='';
    try{
      const r=await fetch(api(`/tickers/${ex}?symbols=${tickerSymbols.join(',')}`));
      const j=await r.json();
      for(const sym of tickerSymbols){
        const t=j[sym]||j[sym.replace('/','')]||{};
        const p=t.last??t.price??t.close;
        row+=`<td>${p!=null?Number(p).toFixed(4):'—'}</td>`;
      }
    }catch(e){
      row=tickerSymbols.map(()=>'<td>—</td>').join('');
    }
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${ex}</td>${row}`;
    body.appendChild(tr);
  }
}

async function saveConfig(){
  const ex = document.getElementById('cfg-exchange').value;
  const key = document.getElementById('cfg-key').value.trim();
  const sec = document.getElementById('cfg-secret').value.trim();
  let output = '';
  if(key && sec){
    try{
      const r = await fetch(api('/cli/run'), {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({command: `secrets set ${ex} ${key} ${sec}`})
      });
      const j = await r.json();
      output = (j.stdout||'') + (j.stderr ? '\n'+j.stderr : '');
      localStorage.setItem('key:'+ex, key);
      localStorage.setItem('secret:'+ex, sec);
    }catch(e){ output = String(e); }
  }
  document.getElementById('cfg-output').textContent = output || 'Credenciales guardadas';
}

loadExchanges();
refreshHealth();
setInterval(refreshHealth, 5000);
refreshMetrics();
setInterval(refreshMetrics, 5000);
refreshMarket();
setInterval(refreshMarket, 5000);
refreshBalances();
setInterval(refreshBalances, 5000);
refreshTickers();
setInterval(refreshTickers, 5000);

async function refreshLogs(){
  try{
    const r=await fetch(api('/logs?lines=200'));
    const j=await r.json();
    document.getElementById('logs').textContent=(j.items||[]).join('\n');
  }catch(e){}
}
refreshLogs();
setInterval(refreshLogs,5000);

document.getElementById('cfg-save').addEventListener('click', saveConfig);
</script>
</body>
</html>
