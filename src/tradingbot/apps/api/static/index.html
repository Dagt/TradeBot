<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <link rel="icon" href="/static/favicon.ico">
  <title>DMI - TradingBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/styles.css"/>
  <script src="/static/header.js" defer></script>
</head>
<body>
  <h1>Monitoreo</h1>
  <div class="muted" id="health">Comprobando estado…</div>
  <div class="grid2" style="margin:14px 0 10px">
    <div class="card card-sm">
      <h2>Balances</h2>
      <table id="bal-table">
        <thead>
          <tr><th>Exchange</th><th>USDT</th><th>BTC</th></tr>
        </thead>
        <tbody id="bal-body"></tbody>
      </table>
    </div>

    <div class="card card-sm">
      <h2>Tickers</h2>
      <table id="tick-table">
        <thead>
          <tr><th>Exchange</th><th>BTC/USDT</th><th>ETH/USDT</th><th>XRP/USDT</th></tr>
        </thead>
        <tbody id="tick-body"></tbody>
      </table>
    </div>
  </div>
  <div class="grid5" style="margin:14px 0 10px">
    <div class="kv"><div class="k">Reject Rate</div><div class="v" id="m-reject">—</div></div>
    <div class="kv"><div class="k">Latency p90 (s)</div><div class="v" id="m-lat90">—</div></div>
    <div class="kv"><div class="k">Latency p99 (s)</div><div class="v" id="m-lat99">—</div></div>
    <div class="kv"><div class="k">WS Uptime %</div><div class="v" id="m-ws-up">—</div></div>
    <div class="kv"><div class="k">Reconex/hr</div><div class="v" id="m-ws-rec">—</div></div>
  </div>
  <div class="grid5" style="margin:0 0 10px">
    <div class="kv"><div class="k">Book Lag (ms)</div><div class="v" id="m-book-lag">—</div></div>
    <div class="kv"><div class="k">CPU %</div><div class="v" id="m-cpu">—</div></div>
    <div class="kv"><div class="k">Mem (MB)</div><div class="v" id="m-mem">—</div></div>
    <div class="kv"><div class="k">FDs</div><div class="v" id="m-fds">—</div></div>
    <div class="kv"><div class="k">Uptime (s)</div><div class="v" id="m-uptime">—</div></div>
  </div>
  <div class="grid5" style="margin:0 0 10px">
    <div class="kv"><div class="k">Ingest rate</div><div class="v" id="m-ingest">—</div></div>
    <div class="kv"><div class="k">Persist backlog</div><div class="v" id="m-backlog">—</div></div>
    <div class="kv"><div class="k">HTTP 4xx</div><div class="v" id="m-err-4xx">—</div></div>
    <div class="kv"><div class="k">HTTP 5xx</div><div class="v" id="m-err-5xx">—</div></div>
    <div class="kv"><div class="k">Timeouts</div><div class="v" id="m-err-timeout">—</div></div>
  </div>
  <div class="grid4" style="margin:0 0 10px">
    <div class="kv"><div class="k">Throttling</div><div class="v" id="m-err-throttle">—</div></div>
    <div class="kv"><div class="k">Auth Errors</div><div class="v" id="m-err-auth">—</div></div>
    <div class="kv"><div class="k">Spread</div><div class="v" id="m-spread">—</div></div>
    <div class="kv"><div class="k">Depth</div><div class="v" id="m-depth">—</div></div>
  </div>
  <div class="grid4" style="margin:0 0 20px">
    <div class="kv"><div class="k">Funding</div><div class="v" id="m-funding-now">—</div></div>
    <div class="kv"><div class="k">Próx Funding</div><div class="v" id="m-funding-next">—</div></div>
    <div class="kv"><div class="k">Basis</div><div class="v" id="m-basis">—</div></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Credenciales</h2>
    <div class="grid3" style="margin-top:10px">
      <div>
        <label for="cfg-exchange">Exchange</label>
        <select id="cfg-exchange"></select>
      </div>
      <div>
        <label for="cfg-key">API Key</label>
        <input id="cfg-key" placeholder="clave"/>
      </div>
      <div>
        <label for="cfg-secret">API Secret</label>
        <input id="cfg-secret" type="password" placeholder="secreto"/>
      </div>
    </div>
    <button id="cfg-save" style="margin-top:10px">Guardar credenciales</button>
    <pre id="cfg-output" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Logs</h2>
    <pre id="logs" class="mono" style="overflow:auto; max-height:60vh"></pre>
  </div>

<script>
const api = (path) => `${location.origin}${path}`;
const allowedExchanges = [
  'binance_spot',
  'binance_futures',
  'binance_spot_testnet',
  'binance_futures_testnet',
  'okx_spot',
  'okx_spot_testnet',
  'okx_futures',
  'okx_futures_testnet',
  'bybit_spot',
  'bybit_spot_testnet',
  'bybit_futures',
  'bybit_futures_testnet',
];

// Track whether the backend has emitted any trading events. If no events have
// occurred yet (orders_sent, fills, etc.), metrics returning 0 are rendered as
// "N/A" to indicate insufficient data.
let metricsHaveEvents = false;

function updateCredInputs(){
  const ex = document.getElementById('cfg-exchange').value;
  document.getElementById('cfg-key').value = localStorage.getItem('key:'+ex) || '';
  document.getElementById('cfg-secret').value = localStorage.getItem('secret:'+ex) || '';
}

async function loadExchanges(){
  try{
    const r = await fetch(api('/ccxt/exchanges?include_testnet=1'));
    const exchanges = await r.json();
    const sel = document.getElementById('cfg-exchange');
    sel.innerHTML = '';
    for(const ex of exchanges){
      if(!allowedExchanges.includes(ex)) continue;
      const opt = document.createElement('option');
      opt.value = ex;
      opt.textContent = ex;
      sel.appendChild(opt);
    }
    const last = localStorage.getItem('exchange');
    if(last && allowedExchanges.includes(last)){
      sel.value = last;
    }
    sel.addEventListener('change', () => {
      localStorage.setItem('exchange', sel.value);
      updateCredInputs();
    });
    updateCredInputs();
  }catch(e){
    console.error(e);
  }
}

async function refreshHealth(){
  try {
    const r = await fetch(api('/health'));
    const j = await r.json();
    const s = j.status === 'ok' ? '<span class="ok">OK</span>' : '<span class="warn">WARN</span>';
    const db = j.db ? '<span class="ok">DB</span>' : '<span class="warn">no DB</span>';
    document.getElementById('health').innerHTML = `Estado: ${s} · ${db}`;
  } catch(e){
    document.getElementById('health').innerHTML = '<span class="warn">Sin conexión</span>';
  }
}

async function refreshMetrics(){
  try{
    const r = await fetch(api('/metrics'));
    const j = await r.json();
    // Determine if any event-driven metrics have been recorded so far. When no
    // events exist, zero values represent missing data rather than true zeros.
    metricsHaveEvents = (j.orders_sent||0) > 0 || (j.fills||0) > 0 || (j.risk_events||0) > 0;

    const show = (id, val, decimals = 2, suffix = '') => {
      const num = Number(val) || 0;
      document.getElementById(id).textContent = (!metricsHaveEvents && num === 0)
        ? 'N/A'
        : num.toFixed(decimals) + suffix;
    };

    show('m-reject', (j.order_reject_rate||0)*100, 2, '%');
    show('m-ws-up', (j.ws_uptime||0)*100, 2, '%');
    show('m-ws-rec', j.ws_reconnections_per_hour, 2);
    show('m-book-lag', j.book_lag_ms, 1);
    show('m-cpu', j.cpu_percent, 1);
    show('m-mem', (j.memory_bytes||0)/1048576, 1);
    show('m-fds', j.fd_count, 0);
    show('m-uptime', j.process_uptime_seconds, 0);
    show('m-ingest', j.ingest_rate, 1);
    show('m-backlog', j.persist_backlog, 0);
    show('m-err-4xx', j.errors_4xx, 0);
    show('m-err-5xx', j.errors_5xx, 0);
    show('m-err-timeout', j.errors_timeout, 0);
    show('m-err-throttle', j.errors_throttling, 0);
    show('m-err-auth', j.errors_auth, 0);
    try{
      const l = await fetch(api('/metrics/latency'));
      const lj = await l.json();
      show('m-lat90', lj.p90, 3);
      show('m-lat99', lj.p99, 3);
    }catch(e){}
  }catch(e){}
}

async function refreshMarket(){
  try{
    const r = await fetch(api('/metrics/market'));
    const j = await r.json();
    // Reuse the metricsHaveEvents flag so market metrics can also display
    // "N/A" when the system has not yet produced any events.
    const show = (id, val, decimals = 4) => {
      const num = Number(val) || 0;
      document.getElementById(id).textContent = (!metricsHaveEvents && num === 0)
        ? 'N/A'
        : num.toFixed(decimals);
    };

    show('m-spread', j.spread, 4);
    show('m-depth', j.depth, 0);
    show('m-funding-now', j.funding_current, 4);
    show('m-funding-next', j.funding_next, 4);
    show('m-basis', j.basis, 4);
    if(j.basis_alert){
      document.getElementById('m-basis').classList.add('warn');
    }else{
      document.getElementById('m-basis').classList.remove('warn');
  }
  }catch(e){}
}

const balCells={};
const tickCells={};
const tickerSymbols=['BTC/USDT','ETH/USDT','XRP/USDT'];

function initTables(){
  const balBody=document.getElementById('bal-body');
  const tickBody=document.getElementById('tick-body');
  if(!balBody||!tickBody) return;
  balBody.innerHTML='';
  tickBody.innerHTML='';
  Object.keys(balCells).forEach(k=>delete balCells[k]);
  Object.keys(tickCells).forEach(k=>delete tickCells[k]);
  const exs=allowedExchanges.filter(ex=>localStorage.getItem('key:'+ex)&&localStorage.getItem('secret:'+ex));
  for(const ex of exs){
    const btr=document.createElement('tr');
    btr.innerHTML=`<td>${ex}</td><td class="muted">...</td><td class="muted">...</td>`;
    balCells[ex]={usdt:btr.children[1], btc:btr.children[2]};
    balBody.appendChild(btr);

    const ttr=document.createElement('tr');
    ttr.innerHTML=`<td>${ex}</td>`+tickerSymbols.map(()=>'<td class="muted">...</td>').join('');
    const tds=ttr.querySelectorAll('td');
    tickCells[ex]={};
    tickerSymbols.forEach((sym,i)=>{tickCells[ex][sym]=tds[i+1];});
    tickBody.appendChild(ttr);
  }
}

async function refreshBalances(){
  const exs=Object.keys(balCells);
  const promises=exs.map(async ex=>{
    const cells=balCells[ex];
    cells.usdt.textContent='...';
    cells.btc.textContent='...';
    cells.usdt.classList.add('muted');
    cells.btc.classList.add('muted');
    try{
      const r=await fetch(api(`/balances/${ex}`));
      const j=await r.json();
      if(!r.ok||j.error||j.USDT==null||j.BTC==null){
        console.warn('balance_error',ex,j.error||j.detail);
        cells.usdt.textContent='N/A';
        cells.btc.textContent='N/A';
      }else{
        cells.usdt.textContent=Number(j.USDT).toFixed(2);
        cells.btc.textContent=Number(j.BTC).toFixed(6);
      }
    }catch(e){
      console.warn('balance_fetch_error',ex,e);
      cells.usdt.textContent='N/A';
      cells.btc.textContent='N/A';
    }finally{
      cells.usdt.classList.remove('muted');
      cells.btc.classList.remove('muted');
    }
  });
  await Promise.all(promises);
}

async function refreshTickers(){
  const exs=Object.keys(tickCells);
  // prepare placeholders
  exs.forEach(ex=>{
    const cells=tickCells[ex];
    tickerSymbols.forEach(sym=>{
      cells[sym].textContent='...';
      cells[sym].classList.add('muted');
    });
  });

  const requests=exs.map(ex=>
    fetch(api(`/tickers/${ex}?symbols=${tickerSymbols.join(',')}`))
      .then(async r=>({ex, ok:r.ok, data:await r.json()}))
      .catch(err=>({ex, ok:false, error:err}))
  );

  const results=await Promise.all(requests);
  for(const {ex, ok, data, error} of results){
    const cells=tickCells[ex];
    try{
      if(!ok||data.error){
        console.warn('ticker_error',ex,(data&&data.error)||error);
        tickerSymbols.forEach(sym=>{cells[sym].textContent='N/A';});
      }else{
        for(const sym of tickerSymbols){
          const t=data[sym]||data[sym.replace('/','')]||{};
          const p=t.last??t.price??t.close;
          cells[sym].textContent=p!=null?Number(p).toFixed(4):'N/A';
        }
      }
    }catch(e){
      console.warn('ticker_fetch_error',ex,e);
      tickerSymbols.forEach(sym=>{cells[sym].textContent='N/A';});
    }finally{
      tickerSymbols.forEach(sym=>cells[sym].classList.remove('muted'));
    }
  }
}

async function saveConfig(){
  const ex = document.getElementById('cfg-exchange').value;
  const key = document.getElementById('cfg-key').value.trim();
  const sec = document.getElementById('cfg-secret').value.trim();
  let output = '';
  if(key && sec){
    try{
      const pref = ex.toUpperCase();
      const rKey = await fetch(api(`/secrets/${pref}_API_KEY`), {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({value: key})
      });
      const rSec = await fetch(api(`/secrets/${pref}_API_SECRET`), {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({value: sec})
      });
      const jKey = await rKey.json().catch(() => ({}));
      const jSec = await rSec.json().catch(() => ({}));
      if(rKey.ok && rSec.ok && jKey.status==='ok' && jSec.status==='ok'){
        localStorage.setItem('key:'+ex, key);
        localStorage.setItem('secret:'+ex, sec);
      }else{
        output = (jKey.detail||jKey.error||'') + (jSec.detail||jSec.error ? `\n${jSec.detail||jSec.error}` : '');
      }
    }catch(e){ output = String(e); }
  }
  document.getElementById('cfg-output').textContent = output || 'Credenciales guardadas';
  initTables();
}

loadExchanges();
refreshHealth();
setInterval(refreshHealth, 5000);
refreshMetrics();
setInterval(refreshMetrics, 5000);
refreshMarket();
setInterval(refreshMarket, 5000);
initTables();
refreshBalances();
setInterval(refreshBalances, 5000);
refreshTickers();
setInterval(refreshTickers, 5000);

async function refreshLogs(){
  try{
    const r=await fetch(api('/logs?lines=200'));
    const j=await r.json();
    document.getElementById('logs').textContent=(j.items||[]).join('\n');
  }catch(e){}
}
refreshLogs();
setInterval(refreshLogs,5000);

document.getElementById('cfg-save').addEventListener('click', saveConfig);
</script>
</body>
</html>
