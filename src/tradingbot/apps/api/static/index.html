<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Monitoreo - TradingBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/styles.css"/>
</head>
<body>
  <nav>
    <img src="/static/logo.png" alt="DMI Bot Trading"/>
    <a href="/">Monitoreo</a>
    <a href="/bots">Bots</a>
    <a href="/stats">Estadísticas operativas</a>
  </nav>
  <h1>Monitoreo</h1>
  <div class="muted" id="health">Comprobando estado…</div>
  <div class="grid4" style="margin:14px 0 20px">
    <div class="kv"><div class="k">Reject Rate</div><div class="v" id="m-reject">—</div></div>
    <div class="kv"><div class="k">CPU %</div><div class="v" id="m-cpu">—</div></div>
    <div class="kv"><div class="k">Mem (MB)</div><div class="v" id="m-mem">—</div></div>
    <div class="kv"><div class="k">Uptime (s)</div><div class="v" id="m-uptime">—</div></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Credenciales</h2>
    <div class="grid3" style="margin-top:10px">
      <div>
        <label for="cfg-exchange">Exchange</label>
        <select id="cfg-exchange">
          <option value="binance_spot">Binance Spot</option>
          <option value="binance_futures_um">Binance Futuros</option>
          <option value="bybit_spot">Bybit Spot</option>
          <option value="okx_spot">OKX Spot</option>
        </select>
      </div>
      <div>
        <label for="cfg-key">API Key</label>
        <input id="cfg-key" placeholder="clave"/>
      </div>
      <div>
        <label for="cfg-secret">API Secret</label>
        <input id="cfg-secret" type="password" placeholder="secreto"/>
      </div>
    </div>
    <button id="cfg-save" style="margin-top:10px">Guardar credenciales</button>
    <pre id="cfg-output" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

<script>
const api = (path) => `${location.origin}${path}`;

async function refreshHealth(){
  try {
    const r = await fetch(api('/health'));
    const j = await r.json();
    const s = j.status === 'ok' ? '<span class="ok">OK</span>' : '<span class="warn">WARN</span>';
    const db = j.db ? '<span class="ok">DB</span>' : '<span class="warn">no DB</span>';
    document.getElementById('health').innerHTML = `Estado: ${s} · ${db}`;
  } catch(e){
    document.getElementById('health').innerHTML = '<span class="warn">Sin conexión</span>';
  }
}

async function refreshMetrics(){
  try{
    const r = await fetch(api('/metrics'));
    const j = await r.json();
    document.getElementById('m-reject').textContent = ((j.order_reject_rate||0)*100).toFixed(2)+'%';
    document.getElementById('m-cpu').textContent = (j.cpu_percent||0).toFixed(1);
    document.getElementById('m-mem').textContent = ((j.memory_bytes||0)/1048576).toFixed(1);
    document.getElementById('m-uptime').textContent = (j.process_uptime_seconds||0).toFixed(0);
  }catch(e){}
}

async function saveConfig(){
  const ex = document.getElementById('cfg-exchange').value;
  const key = document.getElementById('cfg-key').value.trim();
  const sec = document.getElementById('cfg-secret').value.trim();
  let output = '';
  if(key && sec){
    try{
      const r = await fetch(api('/cli/run'), {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({command: `secrets set ${ex} ${key} ${sec}`})
      });
      const j = await r.json();
      output = (j.stdout||'') + (j.stderr ? '\n'+j.stderr : '');
    }catch(e){ output = String(e); }
  }
  document.getElementById('cfg-output').textContent = output || 'Credenciales guardadas';
}

refreshHealth();
setInterval(refreshHealth, 5000);
refreshMetrics();
setInterval(refreshMetrics, 5000);

document.getElementById('cfg-save').addEventListener('click', saveConfig);
</script>
</body>
</html>
