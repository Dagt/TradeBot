<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <link rel="icon" href="/static/favicon.ico">
  <title>DMI - TradingBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/styles.css"/>
  <style>
  @keyframes blink{0%,100%{opacity:.2;}50%{opacity:1;}}
  #bt-working{animation:blink 1s linear infinite;display:none;margin-left:8px;}
  </style>
</head>
<body>
<header class="center" style="margin-bottom:8px">
  <div class="logo-wrap">
  <img src="/static/logo.png" alt="DMI Bot Trading" class="logo">
</div>

  <nav>
  <div class="menu">
    <a href="/" class="">Monitoreo</a>
    <a href="/bots" class="">Bots</a>
    <a href="/stats" class="">Estadísticas operativas</a>
    <a href="/data" class="">Datos históricos</a>
    <a href="/backtest" class="active">Backtest</a>
    <a href="http://localhost:3000/" target="_blank" class="">Grafana</a>
    <a href="http://localhost:9090/" target="_blank" class="">Prometheus</a>

  </div>
</nav>

</header>
  <h1>Backtest</h1>

  <div class="card">
    <h2>Ejecutar backtest</h2>
    <div class="grid3" style="margin-top:10px">
      <div>
        <label for="bt-mode">Modo</label>
        <select id="bt-mode">
          <option value="csv">CSV</option>
          <option value="cfg">Config YAML</option>
          <option value="walk">Walk-forward</option>
          <option value="db">Base de datos</option>
        </select>
      </div>
      <div id="field-data">
        <label for="bt-data">Archivo CSV</label>
        <input id="bt-data" placeholder="data.csv"/>
      </div>
      <div id="field-symbol">
        <label for="bt-symbol">Símbolo</label>
        <input id="bt-symbol" placeholder="BTC/USDT"/>
      </div>
      <div id="field-strategy">
        <label for="bt-strategy">Estrategia</label>
        <select id="bt-strategy"></select>
      </div>
      <div id="field-strategy-config">
        <label for="bt-strategy-config">Config estrategia</label>
        <input id="bt-strategy-config" placeholder="config.yaml"/>
      </div>
      <div id="field-capital">
        <label for="bt-capital">Capital inicial</label>
        <input id="bt-capital" type="number" step="any" placeholder=""/>
      </div>
      <div id="field-config">
        <label for="bt-config">Archivo config</label>
        <input id="bt-config" placeholder="config.yaml"/>
      </div>
      <div id="field-venue">
        <label for="bt-venue">Exchange</label>
        <select id="bt-venue"></select>
      </div>
      <div id="field-start">
        <label for="bt-start">Inicio</label>
        <input id="bt-start" type="date"/>
      </div>
      <div id="field-end">
        <label for="bt-end">Fin</label>
        <input id="bt-end" type="date"/>
      </div>
      <div id="field-risk-pct">
        <label for="bt-risk-pct">Risk %</label>
        <input id="bt-risk-pct" type="number" step="any"/>
      </div>
      <div id="field-fee-bps">
        <label for="bt-fee-bps">Comisión (bps)</label>
        <input id="bt-fee-bps" type="number" step="any" placeholder="5"/>
      </div>
      <div id="field-slippage-bps">
        <label for="bt-slippage-bps">Slippage (bps)</label>
        <input id="bt-slippage-bps" type="number" step="any" placeholder="1"/>
      </div>
      <div id="field-verbose-fills">
  <span>Exportar fills (CSV)</span>
  <label class="switch">
    <input id="bt-verbose-fills" type="checkbox">
    <span class="slider"></span>
  </label>
</div>

      <div id="field-toggle-params" style="display:flex;align-items:center;gap:4px">
        <span>Configurar parámetros</span>
        <label class="switch"><input id="bt-toggle-params" type="checkbox"><span class="slider"></span></label>
      </div>
    </div>
    <div id="bt-param-card" style="display:none">
      <div id="bt-strategy-params" class="param-grid"></div>
    </div>
    <p id="bt-strategy-info" class="dm-kind-desc" style="grid-column:1 / -1;"></p>
    <button id="bt-run" style="margin-top:10px">Ejecutar</button>
    <button id="bt-stop" style="margin-top:10px;margin-left:8px" disabled>Detener</button>
    <button id="bt-clear" style="margin-top:10px;margin-left:8px">Limpiar</button>
    <span id="bt-working">Procesando<span id="bt-dots"></span></span>
    <pre id="bt-output" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Comandos CLI</h2>
    <div class="muted">Ejecuta cualquier comando de <code>tradingbot.cli</code></div>
    <input id="cli-input" class="mono" placeholder="--help"/>
    <button id="cli-run" style="margin-top:8px">Ejecutar</button>
    <pre id="cli-output" class="mono" style="margin-top:8px; white-space:pre-wrap"></pre>
  </div>

<script>
const api = (path) => `${location.origin}${path}`;

function normalizeSymbol(sym) {
  return sym.replace(/[^A-Za-z0-9]/g, "");
}

function appendOutput(out,text){
  out.textContent+=text+"\n";
  requestAnimationFrame(()=>out.scrollTop=out.scrollHeight);
}

function showWorking(){
  const span=document.getElementById('bt-working');
  if(span) span.style.display='inline';
}

function hideWorking(){
  const span=document.getElementById('bt-working');
  if(span) span.style.display='none';
}

let currentJob=null;
let evt=null;

const strategies = {
  breakout_atr: {
    desc: "Aprovecha rupturas de un canal calculado con el Average True Range (ATR). Compra al superar la banda superior y vende al romper la inferior.",
    requires: ["ohlcv"],
  },
  breakout_vol: {
    desc: "Busca expansiones de volatilidad. Entra cuando el precio abandona su rango normal con un aumento notable del rango de la vela.",
    requires: ["ohlcv"],
  },
  momentum: {
    desc: "Sigue la tendencia usando el RSI como medidor de impulso. Opera a favor del movimiento cuando el indicador se mantiene en zonas extremas.",
    requires: ["ohlcv"],
  },
  mean_reversion: {
    desc: "Opera la vuelta a la media apoyándose en el RSI. Compra en condiciones de sobreventa y vende en sobrecompra.",
    requires: ["ohlcv"],
  },
  triangular_arb: {
    desc: "Explota ineficiencias entre tres pares realizando un ciclo de intercambios para obtener beneficio sin exposición direccional.",
    requires: ["prices"],
  },
  cash_and_carry: {
    desc: "Captura la base entre mercado spot y futuros perpetuos, manteniendo posiciones opuestas y cobrando la tasa de financiamiento.",
    requires: ["spot", "perp", "funding"],
  },
  order_flow_imbalance: {
    desc: "Evalúa el desequilibrio entre órdenes de compra y venta agresivas para anticipar movimientos de precio.",
    requires: ["bba", "book_delta"],
  },
  depth_imbalance: {
    desc: "Mide la disparidad de liquidez entre el lado comprador y vendedor del libro para detectar presión latente.",
    requires: ["book_delta"],
  },
  liquidity_events: {
    desc: "Identifica vacíos y gaps de liquidez en el libro que pueden generar movimientos bruscos.",
    requires: ["bba", "book_delta"],
  },
  triple_barrier: {
    desc: "Genera señales usando la metodología de triple barrera con objetivos y stop temporales.",
    requires: ["ohlcv"],
  },
  ml: {
    desc: "Ejecuta un modelo de machine learning entrenado con indicadores y estadísticas personalizadas.",
    requires: ["features"],
  },
  mean_rev_ofi: {
    desc: "Busca la reversión a la media basada en el Order Flow Imbalance (OFI) derivado del libro de órdenes.",
    requires: ["book_delta"],
  },
  order_flow: {
    desc: "Analiza el flujo de órdenes agresivas vs. pasivas para estimar micro‑tendencias.",
    requires: ["trades", "book_delta"],
  },
  trend_following: {
    desc: "Seguimiento de tendencia con fuerza adaptativa",
    requires: ["ohlcv"],
  },
  cross_arbitrage: {
    desc: "Arbitraje del mismo par entre dos exchanges; compra donde esté barato y vende donde esté caro.",
    requires: ["prices"],
  },
  scalp_pingpong: {
    desc: "Scalping de reversión a la media con z‑score",
    requires: ["ohlcv"],
  },
  composite_signals: {
    desc: "Combina señales de múltiples subestrategias",
    requires: [],
  },
};

const dataInfo = {
  ohlcv: "Serie de velas con Open-High-Low-Close-Volume.",
  prices: "Secuencia de precios (spot o perp) en ticks/velas, útil para spreads.",
  bba: "Best Bid/Ask (mejor postor y oferente) con sus volúmenes.",
  book_delta: "Variaciones por nivel del libro entre dos snapshots consecutivos.",
  trades: "Historial de operaciones ejecutadas (agresivas).",
  spot: "Precio de mercado spot.",
  perp: "Precio de futuros perpetuos.",
  funding: "Historial de tasas de financiamiento de los perpetuos.",
  features: "Indicadores y estadísticas usados por un modelo de ML.",
};

async function loadStrategyParams(name){
  const container=document.getElementById('bt-strategy-params');
  container.innerHTML='';
  const card=document.getElementById('bt-param-card');
  card.style.display='none';
  const toggle=document.getElementById('bt-toggle-params');
  toggle.checked=false;
  const field=document.getElementById('field-toggle-params');
  field.style.display='none';
  try{
    const r=await fetch(api(`/strategies/${name}/schema`));
    const j=await r.json();
    const params=(j.params||[]).filter(p=>p.name!=='config_path');
    field.style.display=params.length?'':'none';
    params.forEach(p=>{
      const div=document.createElement('div');
      const label=document.createElement('label');
      label.htmlFor=`bt-param-${p.name}`;
      label.textContent=p.name;
      const help=document.createElement('span');
      help.className='help-icon';
      help.title=p.desc||'';
      help.textContent='?';
      label.appendChild(help);
      const input=document.createElement('input');
      input.className='param-input';
      input.id=`bt-param-${p.name}`;
      input.dataset.name=p.name;
      input.dataset.type=p.type||'';
      const type=(p.type||'').toLowerCase();
      if(type.includes('int')||type.includes('float')||type.includes('number')){
        input.type='number'; input.step='0.0001';
      }else{ input.type='text'; }
      if(p.default!==undefined && p.default!==null) input.value=p.default;
      div.appendChild(label); div.appendChild(input);
      container.appendChild(div);
    });
  }catch(e){}
}

let strategyInfo = {};

async function loadStrategyInfo(){
  try{
    const r=await fetch(api('/strategies/info'));
    const j=await r.json();
    strategyInfo={...strategies,...j};
  }catch(e){
    console.error(e);
    strategyInfo=strategies;
  }
  updateStrategyInfo();
}

function appendSummary(text){
  try{
    let eq=null,pnl=null,fills=null,dd=null,slip=null;
    const re=/Backtest finalizado: equity (\S+), pnl (\S+), fills (\d+), drawdown (\S+)%/;
    const m=text.match(re);
    if(m){
      eq=parseFloat(m[1]);
      pnl=parseFloat(m[2]);
      fills=parseInt(m[3],10);
      dd=parseFloat(m[4]);
    }else{
      const eqMatch=text.match(/'equity':\s*(\S+)/);
      const pnlMatch=text.match(/'pnl':\s*(\S+)/);
      const ddMatch=text.match(/'max_drawdown':\s*(\S+)/);
      const fillsMatch=text.match(/'fills':\s*\[(.*)\]/s);
      const slipMatch=text.match(/'slippage':\s*(\S+)/);
      eq=eqMatch?parseFloat(eqMatch[1]):null;
      pnl=pnlMatch?parseFloat(pnlMatch[1]):null;
      dd=ddMatch?parseFloat(ddMatch[1])*100:null;
      slip=slipMatch?parseFloat(slipMatch[1]):null;
      if(fillsMatch){
        fills=(fillsMatch[1].match(/\(/g)||[]).length;
      }
    }
    const out=document.getElementById('bt-output');
    const lines=[
      '',
      `equity final ≈ ${eq!=null&&!isNaN(eq)?eq.toFixed(2):(m?m[1]:'N/A')}`,
      `pnl total ≈ ${pnl!=null&&!isNaN(pnl)?pnl.toFixed(2):(m?m[2]:'N/A')}`,
      `${fills!=null?fills:'N/A'} fills (operaciones ejecutadas)`,
      `drawdown máximo ≈ ${dd!=null&&!isNaN(dd)?dd.toFixed(2):(m?m[4]:'N/A')}%`,
    ];
    if(slip!=null&&!isNaN(slip)){
      lines.push(`slippage medio ≈ ${slip.toFixed(2)}`);
    }
    lines.push('');
    lines.forEach(l=>appendOutput(out,l));
  }catch(e){/* ignore parsing errors */}
}

async function loadExchanges(){
  try{
    const r = await fetch(api('/ccxt/exchanges'));
    const exchanges = (await r.json()).filter(
      ex => !ex.endsWith('_testnet') && !ex.endsWith('_ws')
    );
    const sel = document.getElementById('bt-venue');
    sel.innerHTML = '';
    for(const ex of exchanges){
      const opt = document.createElement('option');
      opt.value = ex;
      opt.textContent = ex;
      sel.appendChild(opt);
    }
  }catch(e){
    console.error(e);
  }
}

async function loadStrategies(){
  try{
    const r=await fetch(api('/strategies/status'));
    const j=await r.json();
    const sel=document.getElementById('bt-strategy');
    sel.innerHTML='';
    Object.keys(j.strategies||{}).forEach(s=>{
      const o=document.createElement('option');
      o.value=s;o.textContent=s;sel.appendChild(o);
    });
    updateStrategyInfo();
    loadStrategyParams(sel.value);
  }catch(e){console.error(e);}
}

function updateBtFields(){
  const mode=document.getElementById('bt-mode').value;
  document.getElementById('field-data').style.display=mode==='csv'?'':'none';
  document.getElementById('field-symbol').style.display=(mode==='csv'||mode==='db')?'':'none';
  document.getElementById('field-strategy').style.display=(mode==='csv'||mode==='db')?'':'none';
  document.getElementById('field-strategy-config').style.display=(mode==='csv'||mode==='db')?'':'none';
  document.getElementById('field-config').style.display=(mode==='cfg'||mode==='walk')?'':'none';
  document.getElementById('field-venue').style.display=mode==='db'?'':'none';
  document.getElementById('bt-venue').style.display=mode==='db'?'':'none';
  document.getElementById('field-start').style.display=mode==='db'?'':'none';
  document.getElementById('field-end').style.display=mode==='db'?'':'none';
  const showRisk = mode!=='walk';
  ['field-risk-pct','field-fee-bps','field-slippage-bps'].forEach(id=>{
    document.getElementById(id).style.display=showRisk?'':'none';
  });
  document.getElementById('bt-strategy-params').style.display=(mode==='csv'||mode==='db')?'':'none';
}

function updateStrategyInfo(){
  const sel=document.getElementById('bt-strategy');
  const info=strategyInfo[sel.value]||{};
  const el=document.getElementById('bt-strategy-info');
  if(info.desc){
    let html=`<p>${info.desc}</p>`;
    if(info.requires && info.requires.length){
      html += "<p>Datos necesarios:</p><ul>" +
              info.requires.map(r => `<li><strong>${r}</strong>: ${dataInfo[r]}</li>`).join("") +
              "</ul>";
    }
    el.innerHTML = html;
  }else{
    el.textContent='';
  }
}

async function runBacktest(){
  if(evt){evt.close();evt=null;}
  const runBtn=document.getElementById('bt-run');
  runBtn.disabled=true;
  runBtn.textContent='Ejecutando...';
  const stopBtn=document.getElementById('bt-stop');
  const outEl=document.getElementById('bt-output');
  outEl.textContent='Iniciando...\n';
  let cmd='';
  const mode=document.getElementById('bt-mode').value;
  const capital=document.getElementById('bt-capital').value.trim();
  if(mode==='csv'){
    const data=document.getElementById('bt-data').value.trim();
    const sym=normalizeSymbol(document.getElementById('bt-symbol').value.trim());
    const strat=document.getElementById('bt-strategy').value.trim();
    cmd=`backtest ${data} --symbol ${sym} --strategy ${strat}`;
  }else if(mode==='cfg'){
    const cfg=document.getElementById('bt-config').value.trim();
    cmd=`backtest-cfg ${cfg}`;
  }else if(mode==='walk'){
    const cfg=document.getElementById('bt-config').value.trim();
    cmd=`walk-forward ${cfg}`;
  }else{
    const venue=document.getElementById('bt-venue').value.trim();
    const sym=normalizeSymbol(document.getElementById('bt-symbol').value.trim());
    const strat=document.getElementById('bt-strategy').value.trim();
    const start=document.getElementById('bt-start').value;
    const end=document.getElementById('bt-end').value;
    cmd=`backtest-db --venue ${venue} --symbol ${sym} --strategy ${strat} --start ${start} --end ${end}`;
  }
  if(capital && mode!=='walk'){
    cmd+=` --capital ${capital}`;
  }
  if(mode!=='walk'){
    const sl=document.getElementById('bt-risk-pct').value.trim();
    if(sl) cmd+=` --risk-pct ${sl}`;
    const fee=document.getElementById('bt-fee-bps').value.trim();
    if(fee) cmd+=` --fee-bps ${fee}`;
    const sb=document.getElementById('bt-slippage-bps').value.trim();
    if(sb) cmd+=` --slippage-bps ${sb}`;
  }
  const stratCfg=document.getElementById('bt-strategy-config').value.trim();
  if(stratCfg) cmd+=` --config ${stratCfg}`;
  const paramEls=document.querySelectorAll('#bt-strategy-params input');
  paramEls.forEach(el=>{
    if(!el.value) return;
    const t=(el.dataset.type||'').toLowerCase();
    let v=el.value;
    if(t.includes('int')) v=parseInt(v,10);
    else if(t.includes('float')||t.includes('number')) v=parseFloat(v);
    cmd+=` --param ${el.dataset.name}=${v}`;
  });
  const verbose=document.getElementById('bt-verbose-fills').checked;
  if(verbose) cmd+=' --fills-csv fills.csv';
  try{
    const r=await fetch(api('/cli/start'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:cmd})});
    const j=await r.json();
    currentJob=j.id;
    stopBtn.disabled=false;
    showWorking();
    evt=new EventSource(api(`/cli/stream/${j.id}`));
    evt.onopen=()=>{appendOutput(outEl,'[conexión abierta]');};
    const origClose=evt.close.bind(evt);
    evt.close=()=>{evt.dispatchEvent(new Event('close'));origClose();};
    evt.onmessage=(e)=>{
      appendOutput(outEl,e.data);
      if(e.data.includes('Backtest finalizado')){
        hideWorking();
      }
    };
    const finish=(msg, btnText='Ejecutar')=>{
      stopBtn.disabled=true;
      runBtn.disabled=btnText==='Finalizado';
      runBtn.textContent=btnText;
      currentJob=null;
      if(evt){evt.close();evt=null;}
      hideWorking();
      appendSummary(outEl.textContent);
      appendOutput(outEl,msg);
    };
    const handleDisconnect=async(label)=>{
      hideWorking();
      try{
        const r=await fetch(api(`/cli/status/${currentJob}`));
        const j=await r.json();
        if(j.status==='finished'){
          finish(`Proceso finalizado (código ${j.returncode}).`);
          return;
        }
        appendOutput(outEl,`[${label}] Estado: ${j.status}`);
      }catch(err){
        appendOutput(outEl,`[${label}] ${err}`);
      }
    };
    evt.addEventListener('status',(e)=>{
      finish(`Proceso finalizado (${e.data}).`);
    });
    evt.addEventListener('end',(e)=>{
      finish(`Proceso finalizado (código ${e.data}).`,'Finalizado');
    });
    evt.onclose=()=>{handleDisconnect('conexión cerrada');};
    evt.addEventListener('close',evt.onclose);
    evt.onerror=()=>{handleDisconnect('error de conexión');};
  }catch(e){
    appendOutput(outEl,String(e));
    runBtn.disabled=false;
    runBtn.textContent='Ejecutar';
    hideWorking();
  }
}

async function stopBacktest(){
  if(!currentJob) return;
  try{await fetch(api(`/cli/stop/${currentJob}`),{method:'POST'});}catch(e){}
  if(evt) evt.close();
  document.getElementById('bt-stop').disabled=true;
  const runBtn=document.getElementById('bt-run');
  runBtn.disabled=false;
  runBtn.textContent='Ejecutar';
  currentJob=null;
  hideWorking();
}

async function runCli(){
  const cmd=document.getElementById('cli-input').value;
  if(!cmd.trim()) return;
  try{
    const r=await fetch(api('/cli/run'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:cmd})});
    const j=await r.json();
    const out=(j.stdout||'')+(j.stderr?`\n${j.stderr}`:'');
    document.getElementById('cli-output').textContent=out;
  }catch(e){
    document.getElementById('cli-output').textContent=String(e);
  }
}

document.getElementById('bt-mode').addEventListener('change',updateBtFields);
document.getElementById('bt-run').addEventListener('click',runBacktest);
document.getElementById('bt-stop').addEventListener('click',stopBacktest);
document.getElementById('bt-clear').addEventListener('click',()=>{
  document.getElementById('bt-output').textContent='';
  hideWorking();
});
document.getElementById('cli-run').addEventListener('click',runCli);
document.getElementById('bt-strategy').addEventListener('change',()=>{
  updateStrategyInfo();
  loadStrategyParams(document.getElementById('bt-strategy').value);
});
document.getElementById('bt-toggle-params').addEventListener('change',e=>{
  document.getElementById('bt-param-card').style.display=e.target.checked?'block':'none';
});
updateBtFields();
loadStrategies();
loadExchanges();
loadStrategyInfo();
loadStrategyParams(document.getElementById('bt-strategy').value);
</script>
</body>
</html>
