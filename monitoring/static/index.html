<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TradeBot Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
  <nav class="navbar" role="navigation">
    <div class="navbar-brand">
      <a class="navbar-item has-text-weight-bold">TradeBot Dashboard</a>
    </div>
  </nav>

  <section class="section">
    <div class="columns is-multiline">
      <div class="column is-one-third">
        <div id="pnl" class="box" style="height:250px;"></div>
      </div>
      <div class="column is-one-third">
        <div id="slippage" class="box" style="height:250px;"></div>
      </div>
      <div class="column is-one-third">
        <div id="latency" class="box" style="height:250px;"></div>
      </div>

        <div class="column is-half">
          <div class="box">
            <h2 class="subtitle">Funding</h2>
            <p id="funding-value">--</p>
          </div>
        </div>
        <div class="column is-half">
          <div class="box">
            <h2 class="subtitle">Open Interest</h2>
            <p id="open-interest-value">--</p>
          </div>
        </div>

        <div class="column is-one-fifth">
          <div class="box">
            <h2 class="subtitle">Fills</h2>
            <p id="fills-value">--</p>
          </div>
        </div>
        <div class="column is-one-fifth">
          <div class="box">
            <h2 class="subtitle">Risk Events</h2>
            <p id="risk-events-value">--</p>
          </div>
        </div>
        <div class="column is-one-fifth">
          <div class="box">
            <h2 class="subtitle">Reject Rate</h2>
            <p id="reject-rate-value">--</p>
          </div>
        </div>
        <div class="column is-one-fifth">
          <div class="box">
            <h2 class="subtitle">CPU %</h2>
            <p id="cpu-value">--</p>
          </div>
        </div>
        <div class="column is-one-fifth">
          <div class="box">
            <h2 class="subtitle">Memory</h2>
            <p id="memory-value">--</p>
          </div>
        </div>

        <div class="column is-full">
          <h2 class="subtitle">Positions</h2>
          <table class="table is-fullwidth is-striped" id="positions-table">
            <thead><tr><th>Symbol</th><th>Position</th><th>Funding Rate</th><th>Basis</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="column is-two-thirds">
          <h2 class="subtitle">Strategies</h2>
          <table class="table is-fullwidth is-striped" id="strategy-table">
            <thead><tr><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="column is-one-third">
        <h2 class="subtitle">Bot Config</h2>
        <div class="box">
          <form id="config-form" onsubmit="saveConfig(event)">
            <div class="field">
              <label class="label">Exchange</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select id="cfg-exchange">
                    <option value="binance">Binance</option>
                    <option value="bybit">Bybit</option>
                    <option value="okx">OKX</option>
                  </select>
                </div>
              </div>
              <p class="help">Select the exchange to trade on.</p>
            </div>
            <div class="field">
              <label class="label">Market</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select id="cfg-market">
                    <option value="spot">Spot</option>
                    <option value="futures">Futures</option>
                  </select>
                </div>
              </div>
              <p class="help">Choose spot or futures market.</p>
            </div>
            <div class="field">
              <label class="label">Trade Qty</label>
              <div class="control">
                <input id="cfg-trade-qty" class="input" type="number" min="0" step="any" placeholder="0.001" />
              </div>
              <p class="help">Base quantity per trade.</p>
            </div>
            <div class="field">
              <label class="label">Leverage</label>
              <div class="control">
                <input id="cfg-leverage" class="input" type="number" min="1" max="125" step="1" placeholder="1" />
              </div>
              <p class="help">Leverage between 1 and 125.</p>
            </div>
            <div class="field">
              <label class="checkbox">
                <input type="checkbox" id="cfg-testnet" checked />
                Testnet
              </label>
              <p class="help">Use exchange test environment.</p>
            </div>
            <div class="field">
              <label class="checkbox">
                <input type="checkbox" id="cfg-dry-run" />
                Dry run
              </label>
              <p class="help">Simulate orders without execution.</p>
            </div>
            <div class="field">
              <label class="label">Strategy</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select id="cfg-strategy"></select>
                </div>
              </div>
              <p class="help">Select the trading strategy.</p>
            </div>
            <div class="field">
              <label class="label">Pairs (comma separated)</label>
              <div class="control">
                <input id="cfg-pairs" class="input" placeholder="BTCUSDT,ETHUSDT" />
              </div>
              <p class="help">Comma-separated trading pairs.</p>
            </div>
            <div class="field">
              <label class="label">Notional</label>
              <div class="control">
                <input id="cfg-notional" class="input" type="number" min="0" step="any" placeholder="1000" />
              </div>
              <p class="help">Total notional position size.</p>
            </div>
            <div id="cfg-params-container"></div>
            <div class="field">
              <div class="control">
                <button type="submit" class="button is-info is-fullwidth">Save</button>
              </div>
            </div>
          </form>
          <div class="field is-grouped">
            <div class="control is-expanded">
              <button id="btn-start" class="button is-success is-fullwidth" onclick="startBot()">Start</button>
            </div>
            <div class="control is-expanded">
              <button id="btn-stop" class="button is-danger is-fullwidth" onclick="stopBot()">Stop</button>
            </div>
          </div>
          <p id="cfg-result"></p>
        </div>
  </div>
      <div class="column is-full">
        <div class="box">
          <h2 class="subtitle">System Metrics</h2>
          <table class="table is-fullwidth" id="system-metrics-table">
            <tbody>
              <tr><th>Disconnects</th><td id="disconnects-value">--</td></tr>
              <tr><th>Orders Sent</th><td id="orders-sent-value">--</td></tr>
              <tr><th>Order Rejects</th><td id="order-rejects-value">--</td></tr>
              <tr><th>WS Failures</th><td id="ws-failures-value">--</td></tr>
              <tr><th>Kill Switch Active</th><td id="kill-switch-value">--</td></tr>
              <tr><th>Avg Market Latency (s)</th><td id="market-latency-value">--</td></tr>
              <tr><th>Avg E2E Latency (s)</th><td id="e2e-latency-value">--</td></tr>
              <tr><th>Avg Maker/Taker Ratio</th><td id="maker-taker-value">--</td></tr>
              <tr><th>Uptime (s)</th><td id="uptime-value">--</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="column is-full">
        <div class="box">
          <h2 class="subtitle">Run CLI Command</h2>
          <div class="field">
            <div class="buttons">
              <button class="button is-primary" onclick="runCLI('paper-run')">Paper Run</button>
              <button class="button is-warning" onclick="runCLI('run-bot --testnet')">Testnet Run</button>
              <button class="button is-danger" onclick="runCLI('real-run')">Real Run</button>
            </div>
          </div>
          <div class="field has-addons">
            <div class="control is-expanded">
              <input id="cli-command" class="input" placeholder="e.g. ingest --venue binance" />
            </div>
            <div class="control">
              <button class="button is-info" onclick="runCLI()">Run</button>
            </div>
          </div>
          <pre id="cli-output" style="max-height:200px;overflow:auto;"></pre>
        </div>
      </div>

  </div>
</section>

 <section class="section">
   <div class="box">
     <h2 class="subtitle">Help / FAQ</h2>
     <p>Need guidance? See the <a href="../docs/usage.md" target="_blank">documentation</a>.</p>
   </div>
 </section>

  <script>
  const pnlTrace = {x: [], y: [], mode: 'lines', name: 'PnL'};
  const slippageTrace = {x: [], y: [], mode: 'lines', name: 'Slippage'};
  const latencyTrace = {x: [], y: [], mode: 'lines', name: 'Latency'};
  Plotly.newPlot('pnl', [pnlTrace], {paper_bgcolor:'#ffffff', plot_bgcolor:'#ffffff', font:{color:'#222'}, title:'PnL'});
  Plotly.newPlot('slippage', [slippageTrace], {paper_bgcolor:'#ffffff', plot_bgcolor:'#ffffff', font:{color:'#222'}, title:'Slippage (bps)'});
  Plotly.newPlot('latency', [latencyTrace], {paper_bgcolor:'#ffffff', plot_bgcolor:'#ffffff', font:{color:'#222'}, title:'Order Latency (s)'});

  function formatBytes(bytes){
    if(bytes === undefined) return '--';
    return (bytes / (1024*1024)).toFixed(2) + ' MB';
  }

  async function updateMetrics(){
    try {
      const now = new Date();
      const res = await fetch('/metrics');
      const metrics = await res.json().catch(()=>({}));
      if(!res.ok){
        document.getElementById('cfg-result').textContent = 'Error: ' + (metrics.detail || res.status);
        return;
      }
      pnlTrace.x.push(now); pnlTrace.y.push(metrics.pnl || 0);
      slippageTrace.x.push(now); slippageTrace.y.push(metrics.avg_slippage_bps || 0);
      latencyTrace.x.push(now); latencyTrace.y.push(metrics.avg_order_latency_seconds || 0);
      Plotly.update('pnl', {x: [pnlTrace.x], y: [pnlTrace.y]});
      Plotly.update('slippage', {x: [slippageTrace.x], y: [slippageTrace.y]});
      Plotly.update('latency', {x: [latencyTrace.x], y: [latencyTrace.y]});
      const funding = Object.values(metrics.funding_rates || {})[0];
      const oi = Object.values(metrics.open_interest || {})[0];
      document.getElementById('funding-value').textContent = funding ?? '--';
      document.getElementById('open-interest-value').textContent = oi ?? '--';
      document.getElementById('fills-value').textContent = metrics.fills ?? '--';
      document.getElementById('risk-events-value').textContent = metrics.risk_events ?? '--';
      const rejectRate = metrics.order_reject_rate ?? 0;
      document.getElementById('reject-rate-value').textContent = (rejectRate * 100).toFixed(2) + '%';
      document.getElementById('cpu-value').textContent = (metrics.cpu_percent ?? 0).toFixed(2) + '%';
      document.getElementById('memory-value').textContent = formatBytes(metrics.memory_bytes);
      document.getElementById('disconnects-value').textContent = metrics.disconnects ?? '--';
      document.getElementById('orders-sent-value').textContent = metrics.orders_sent ?? '--';
      document.getElementById('order-rejects-value').textContent = metrics.order_rejects ?? '--';
      document.getElementById('ws-failures-value').textContent = metrics.ws_failures ?? '--';
      document.getElementById('kill-switch-value').textContent = metrics.kill_switch_active ? 'Yes' : 'No';
      document.getElementById('market-latency-value').textContent = (metrics.avg_market_latency_seconds ?? 0).toFixed(3);
      document.getElementById('e2e-latency-value').textContent = (metrics.avg_e2e_latency_seconds ?? 0).toFixed(3);
      document.getElementById('maker-taker-value').textContent = (metrics.avg_maker_taker_ratio ?? 0).toFixed(3);
      document.getElementById('uptime-value').textContent = (metrics.process_uptime_seconds ?? 0).toFixed(0);
      const posBody = document.querySelector('#positions-table tbody');
      posBody.innerHTML = '';
      const positions = metrics.positions || {};
      const fundingRates = metrics.funding_rates || {};
      const basis = metrics.basis || {};
      for(const symbol of Object.keys(positions)){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${symbol}</td><td>${positions[symbol]}</td><td>${fundingRates[symbol] ?? '--'}</td><td>${basis[symbol] ?? '--'}</td>`;
        posBody.appendChild(tr);
      }
    } catch(err){ console.error(err); }
  }

  async function updateStrategies(){
    try {
      const res = await fetch('/strategies/status');
      const data = await res.json().catch(()=>({}));
      if(!res.ok){
        document.getElementById('cfg-result').textContent = 'Error: ' + (data.detail || res.status);
        return;
      }
      const tbody = document.querySelector('#strategy-table tbody');
      tbody.innerHTML = '';
      for (const [name, status] of Object.entries(data.strategies || {})){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td><td>${status}</td>`+
          `<td><button class="button is-small is-success" onclick="controlStrategy('${name}','enable')">Run</button>`+
          `<button class="button is-small is-warning" onclick="controlStrategy('${name}','disable')">Stop</button></td>`;
        tbody.appendChild(tr);
      }
      const isRunning = Object.values(data.strategies || {}).some(s => s === 'running');
      document.getElementById('btn-start').disabled = isRunning;
    } catch(err){
      document.getElementById('cfg-result').textContent = 'Error: ' + err;
    }
  }

  async function controlStrategy(name, action){
    try {
      const res = await fetch(`/strategies/${name}/${action}`, {method:'POST'});
      if(!res.ok){
        const err = await res.json().catch(()=>({}));
        document.getElementById('cfg-result').textContent = 'Error: ' + (err.detail || res.status);
      }
    } catch(err){
      document.getElementById('cfg-result').textContent = 'Error: ' + err;
    }
    updateStrategies();
  }

  async function loadStrategies(){
    try {
      const res = await fetch('/strategies');
      const data = await res.json().catch(()=>({}));
      if(!res.ok){
        document.getElementById('cfg-result').textContent = 'Error: ' + (data.detail || res.status);
        return;
      }
      const select = document.getElementById('cfg-strategy');
      select.innerHTML = '';
      for (const name of data.strategies || []){
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      }
      select.addEventListener('change', () => loadStrategySchema(select.value));
    } catch(err){
      document.getElementById('cfg-result').textContent = 'Error: ' + err;
    }
  }

  async function loadStrategySchema(name, values={}){
    const container = document.getElementById('cfg-params-container');
    container.innerHTML = '';
    if(!name) return;
    try {
      const res = await fetch(`/strategies/${name}/schema`);
      const data = await res.json().catch(()=>({}));
      if(!res.ok){
        document.getElementById('cfg-result').textContent = 'Error: ' + (data.detail || res.status);
        return;
      }
      for(const param of data.params || []){
        const field = document.createElement('div');
        field.className = 'field';
        const label = document.createElement('label');
        label.className = 'label';
        label.textContent = param.name;
        if(param.description){ label.title = param.description; }
        const control = document.createElement('div');
        control.className = 'control';
        let input;
        if(param.type.includes('bool')){
          input = document.createElement('input');
          input.type = 'checkbox';
          input.className = 'checkbox';
          input.checked = (values[param.name] ?? param.default) || false;
        } else {
          input = document.createElement('input');
          input.className = 'input';
          input.value = values[param.name] ?? param.default ?? '';
          if(param.type.includes('int')){ input.type = 'number'; input.step = '1'; }
          else if(param.type.includes('float')){ input.type = 'number'; input.step = 'any'; }
          else { input.type = 'text'; }
        }
        input.id = `param-${param.name}`;
        input.dataset.param = param.name;
        input.dataset.type = param.type;
        control.appendChild(input);
        field.appendChild(label);
        field.appendChild(control);
        if(param.description){
          const help = document.createElement('p');
          help.className = 'help';
          help.textContent = param.description;
          field.appendChild(help);
        }
        container.appendChild(field);
      }
    } catch(err){
      document.getElementById('cfg-result').textContent = 'Error: ' + err;
    }
  }

  async function loadConfig(){
    try {
      const res = await fetch('/config');
      const data = await res.json().catch(()=>({}));
      if(!res.ok){
        document.getElementById('cfg-result').textContent = 'Error: ' + (data.detail || res.status);
        return;
      }
      const cfg = data.config || {};
      document.getElementById('cfg-strategy').value = cfg.strategy || '';
      document.getElementById('cfg-pairs').value = (cfg.pairs || []).join(',');
      document.getElementById('cfg-notional').value = cfg.notional ?? '';
      document.getElementById('cfg-exchange').value = cfg.exchange || 'binance';
      document.getElementById('cfg-market').value = cfg.market || 'spot';
      document.getElementById('cfg-trade-qty').value = cfg.trade_qty ?? '';
      document.getElementById('cfg-leverage').value = cfg.leverage ?? '';
      document.getElementById('cfg-testnet').checked = cfg.testnet ?? true;
      document.getElementById('cfg-dry-run').checked = cfg.dry_run ?? false;
      await loadStrategySchema(cfg.strategy || '', cfg.params || {});
    } catch(err){
      document.getElementById('cfg-result').textContent = 'Error: ' + err;
    }
  }

  async function saveConfig(ev){
    if(ev) ev.preventDefault();
    const strategy = document.getElementById('cfg-strategy').value;
    const pairs = document.getElementById('cfg-pairs').value
      .split(',')
      .map(p => p.trim())
      .filter(Boolean);
    const exchange = document.getElementById('cfg-exchange').value;
    const market = document.getElementById('cfg-market').value;
    const tradeQtyVal = document.getElementById('cfg-trade-qty').value;
    const leverageVal = document.getElementById('cfg-leverage').value;
    const testnet = document.getElementById('cfg-testnet').checked;
    const dryRun = document.getElementById('cfg-dry-run').checked;
    const notionalVal = document.getElementById('cfg-notional').value;
    const payload = {strategy, pairs, exchange, market, testnet, dry_run: dryRun};
    if(tradeQtyVal){ payload.trade_qty = parseFloat(tradeQtyVal); }
    if(leverageVal){ payload.leverage = parseInt(leverageVal); }
    if(notionalVal){ payload.notional = parseFloat(notionalVal); }
    const paramInputs = document.querySelectorAll('#cfg-params-container [data-param]');
    const params = {};
    for(const input of paramInputs){
      const type = input.dataset.type || '';
      const name = input.dataset.param;
      let value;
      if(type.includes('bool')){
        value = input.checked;
      } else {
        const v = input.value;
        if(v === '') continue;
        if(type.includes('int')) value = parseInt(v);
        else if(type.includes('float')) value = parseFloat(v);
        else value = v;
      }
      params[name] = value;
    }
    if(Object.keys(params).length) payload.params = params;
    try {
      const res = await fetch('/config', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(res.ok){
        document.getElementById('cfg-result').textContent = 'Config saved';
      } else {
        const err = await res.json();
        document.getElementById('cfg-result').textContent = 'Error: ' + (err.detail || res.status);
      }
    } catch(err){
      document.getElementById('cfg-result').textContent = 'Error: ' + err;
    }
  }

  async function startBot(){
    try {
      await saveConfig();
      const res = await fetch('/bot/start', {method:'POST'});
      if(res.ok){
        document.getElementById('cfg-result').textContent = 'Bot started';
        document.getElementById('btn-start').disabled = true;
      } else {
        const err = await res.json();
        document.getElementById('cfg-result').textContent = 'Error: ' + (err.detail || res.status);
      }
    } catch(err) {
      if(err) console.error(err);
    }
    updateStrategies();
  }

  async function stopBot(){
    try {
      const res = await fetch('/bot/stop', {method:'POST'});
      if(res.ok){
        document.getElementById('cfg-result').textContent = 'Bot stopped';
        document.getElementById('btn-start').disabled = false;
      } else {
        const err = await res.json();
        document.getElementById('cfg-result').textContent = 'Error: ' + (err.detail || res.status);
      }
    } catch(err) {
      document.getElementById('cfg-result').textContent = 'Error: ' + err;
    }
    updateStrategies();
  }


  async function runCLI(cmd){
    if(!cmd){
      cmd = document.getElementById('cli-command').value;
      if(!cmd) return;
    }
    const outEl = document.getElementById('cli-output');
    outEl.className = '';
    outEl.textContent = `Running "${cmd}"...`;
    try {
      const res = await fetch('/run-cli', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({command: cmd})
      });
      const data = await res.json();
      let text = '';
      if(data.success){
        text = `✅ "${cmd}" completed`;
        if(data.stdout) text += `\n${data.stdout}`;
        if(data.stderr) text += `\n${data.stderr}`;
        outEl.className = 'has-text-success';
      } else {
        text = `❌ "${cmd}" failed (code ${data.returncode})`;
        if(data.stdout) text += `\n${data.stdout}`;
        if(data.stderr) text += `\n${data.stderr}`;
        outEl.className = 'has-text-danger';
      }
      outEl.textContent = text;
    } catch(err){
      outEl.textContent = 'Error: ' + err;
      outEl.className = 'has-text-danger';
    }
  }

  updateMetrics();
  updateStrategies();
  loadStrategies().then(loadConfig);
  setInterval(()=>{updateMetrics(); updateStrategies();},5000);
  </script>
</body>
</html>

