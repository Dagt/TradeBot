<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TradeBot Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    body { padding: 20px; }
    #cli-output { white-space: pre-wrap; }
  </style>
</head>
<body>
  <section class="section">
    <h1 class="title">TradeBot Monitoring</h1>
    <div class="columns">
      <div class="column">
        <div id="pnl" class="box" style="height:300px;"></div>
        <div id="slippage" class="box" style="height:300px;"></div>
        <div id="latency" class="box" style="height:300px;"></div>
      </div>
    </div>

    <h2 class="subtitle">Estrategias</h2>
    <table class="table is-fullwidth is-striped" id="strategy-table">
      <thead><tr><th>Nombre</th><th>Estado</th><th>Acciones</th></tr></thead>
      <tbody></tbody>
    </table>

    <h2 class="subtitle">Comandos CLI</h2>
    <div class="field has-addons">
      <div class="control is-expanded">
        <input id="cli-cmd" class="input" placeholder="backtest-cfg data/examples/backtest.yaml" />
      </div>
      <div class="control">
        <button class="button is-primary" onclick="runCLI()">Ejecutar</button>
      </div>
    </div>
    <pre id="cli-output" class="box"></pre>
  </section>

<script>
const pnlTrace = {x: [], y: [], mode: 'lines', name: 'PnL'};
const slippageTrace = {x: [], y: [], mode: 'lines', name: 'Slippage'};
const latencyTrace = {x: [], y: [], mode: 'lines', name: 'Latency'};
Plotly.newPlot('pnl', [pnlTrace], {title: 'PnL'});
Plotly.newPlot('slippage', [slippageTrace], {title: 'Slippage (bps)'});
Plotly.newPlot('latency', [latencyTrace], {title: 'Order Latency (s)'});

async function updateMetrics(){
  try {
    const now = new Date();
    const pnl = await fetch('/metrics/pnl').then(r => r.json());
    const slip = await fetch('/metrics/slippage').then(r => r.json());
    const lat = await fetch('/metrics/latency').then(r => r.json());
    pnlTrace.x.push(now); pnlTrace.y.push(pnl.pnl || 0);
    slippageTrace.x.push(now); slippageTrace.y.push(slip.avg_slippage_bps || 0);
    latencyTrace.x.push(now); latencyTrace.y.push(lat.avg_order_latency_seconds || 0);
    Plotly.update('pnl', {x: [pnlTrace.x], y: [pnlTrace.y]});
    Plotly.update('slippage', {x: [slippageTrace.x], y: [slippageTrace.y]});
    Plotly.update('latency', {x: [latencyTrace.x], y: [latencyTrace.y]});
  } catch(err){ console.error(err); }
}

async function updateStrategies(){
  try {
    const data = await fetch('/strategies/status').then(r => r.json());
    const tbody = document.querySelector('#strategy-table tbody');
    tbody.innerHTML = '';
    for (const [name, status] of Object.entries(data.strategies || {})){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${name}</td><td>${status}</td>`+
        `<td><button class="button is-small" onclick="controlStrategy('${name}','enable')">Run</button>`+
        `<button class="button is-small is-warning" onclick="controlStrategy('${name}','disable')">Stop</button></td>`;
      tbody.appendChild(tr);
    }
  } catch(err){ console.error(err); }
}

async function controlStrategy(name, action){
  await fetch(`/strategies/${name}/${action}`, {method:'POST'});
  updateStrategies();
}

async function runCLI(){
  const cmd = document.getElementById('cli-cmd').value;
  const res = await fetch('/run-cli', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({command: cmd})
  });
  const data = await res.json();
  document.getElementById('cli-output').textContent = (data.stdout || '') + '\n' + (data.stderr || '');
}

updateMetrics();
updateStrategies();
setInterval(() => {updateMetrics(); updateStrategies();}, 5000);
</script>
</body>
</html>
