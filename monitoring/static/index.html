<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TradeBot Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
  <nav class="navbar is-dark" role="navigation">
    <div class="navbar-brand">
      <a class="navbar-item has-text-weight-bold">TradeBot Dashboard</a>
    </div>
  </nav>

  <section class="section">
    <div class="columns is-multiline">
      <div class="column is-one-third">
        <div id="pnl" class="box" style="height:250px;"></div>
      </div>
      <div class="column is-one-third">
        <div id="slippage" class="box" style="height:250px;"></div>
      </div>
      <div class="column is-one-third">
        <div id="latency" class="box" style="height:250px;"></div>
      </div>

      <div class="column is-half">
        <div class="box">
          <h2 class="subtitle has-text-light">Funding</h2>
          <p id="funding-value" class="has-text-light">--</p>
        </div>
      </div>
      <div class="column is-half">
        <div class="box">
          <h2 class="subtitle has-text-light">Open Interest</h2>
          <p id="open-interest-value" class="has-text-light">--</p>
        </div>
      </div>

      <div class="column is-two-thirds">
        <h2 class="subtitle has-text-light">Strategies</h2>
        <table class="table is-fullwidth is-striped is-dark" id="strategy-table">
          <thead><tr><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="column is-one-third">
        <h2 class="subtitle has-text-light">Bot Config</h2>
        <div class="box">
          <form id="config-form" onsubmit="saveConfig(event)">
            <div class="field">
              <label class="label has-text-light">Strategy</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select id="cfg-strategy">
                    <option value="breakout_atr">Breakout ATR</option>
                    <option value="momentum">Momentum</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label has-text-light">Pairs (comma separated)</label>
              <div class="control">
                <input id="cfg-pairs" class="input" placeholder="BTCUSDT,ETHUSDT" />
              </div>
            </div>
            <div class="field">
              <label class="label has-text-light">Notional</label>
              <div class="control">
                <input id="cfg-notional" class="input" type="number" min="0" step="any" placeholder="1000" />
              </div>
            </div>
            <div id="cfg-param-fields"></div>
            <div class="field">
              <div class="control">
                <button type="submit" class="button is-info is-fullwidth">Save</button>
              </div>
            </div>
          </form>
          <div class="field is-grouped">
            <div class="control is-expanded">
              <button id="btn-start" class="button is-success is-fullwidth" onclick="startBot()">Start</button>
            </div>
            <div class="control is-expanded">
              <button id="btn-stop" class="button is-danger is-fullwidth" onclick="stopBot()">Stop</button>
            </div>
          </div>
          <p id="cfg-result" class="has-text-light"></p>
        </div>
      </div>

    </div>
  </section>

  <script>
  const pnlTrace = {x: [], y: [], mode: 'lines', name: 'PnL'};
  const slippageTrace = {x: [], y: [], mode: 'lines', name: 'Slippage'};
  const latencyTrace = {x: [], y: [], mode: 'lines', name: 'Latency'};
  Plotly.newPlot('pnl', [pnlTrace], {paper_bgcolor:'#2a2a40', plot_bgcolor:'#2a2a40', font:{color:'#fff'}, title:'PnL'});
  Plotly.newPlot('slippage', [slippageTrace], {paper_bgcolor:'#2a2a40', plot_bgcolor:'#2a2a40', font:{color:'#fff'}, title:'Slippage (bps)'});
  Plotly.newPlot('latency', [latencyTrace], {paper_bgcolor:'#2a2a40', plot_bgcolor:'#2a2a40', font:{color:'#fff'}, title:'Order Latency (s)'});

  async function loadSchema(name, values = {}){
    const container = document.getElementById('cfg-param-fields');
    container.innerHTML = '';
    if(!name) return;
    try {
      const schema = await fetch(`/strategies/${name}/schema`).then(r => r.json());
      for (const p of schema.params || []){
        const field = document.createElement('div');
        field.className = 'field';
        const label = document.createElement('label');
        label.className = 'label has-text-light';
        label.textContent = p.name;
        const control = document.createElement('div');
        control.className = 'control';
        const input = document.createElement('input');
        input.className = 'input';
        input.dataset.name = p.name;
        input.dataset.type = p.type || '';
        const t = (p.type || '').toLowerCase();
        if(t === 'int' || t === 'float' || t === 'number'){
          input.type = 'number';
          input.step = 'any';
        } else if(t === 'bool' || t === 'boolean'){
          input.type = 'checkbox';
        } else {
          input.type = 'text';
        }
        let val = values[p.name];
        if(val === undefined) val = p.default;
        if(input.type === 'checkbox'){
          input.checked = Boolean(val);
        } else if(val !== undefined && val !== null){
          input.value = val;
        }
        control.appendChild(input);
        field.appendChild(label);
        field.appendChild(control);
        container.appendChild(field);
      }
    } catch(err){ console.error(err); }
  }

  async function updateMetrics(){
    try {
      const now = new Date();
      const metrics = await fetch('/metrics').then(r => r.json());
      pnlTrace.x.push(now); pnlTrace.y.push(metrics.pnl || 0);
      slippageTrace.x.push(now); slippageTrace.y.push(metrics.avg_slippage_bps || 0);
      latencyTrace.x.push(now); latencyTrace.y.push(metrics.avg_order_latency_seconds || 0);
      Plotly.update('pnl', {x: [pnlTrace.x], y: [pnlTrace.y]});
      Plotly.update('slippage', {x: [slippageTrace.x], y: [slippageTrace.y]});
      Plotly.update('latency', {x: [latencyTrace.x], y: [latencyTrace.y]});
      const funding = Object.values(metrics.funding_rates || {})[0];
      const oi = Object.values(metrics.open_interest || {})[0];
      document.getElementById('funding-value').textContent = funding ?? '--';
      document.getElementById('open-interest-value').textContent = oi ?? '--';
    } catch(err){ console.error(err); }
  }

  async function updateStrategies(){
    try {
      const data = await fetch('/strategies/status').then(r => r.json());
      const tbody = document.querySelector('#strategy-table tbody');
      tbody.innerHTML = '';
      for (const [name, status] of Object.entries(data.strategies || {})){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td><td>${status}</td>`+
          `<td><button class="button is-small is-success" onclick="controlStrategy('${name}','enable')">Run</button>`+
          `<button class="button is-small is-warning" onclick="controlStrategy('${name}','disable')">Stop</button></td>`;
        tbody.appendChild(tr);
      }
      const isRunning = Object.values(data.strategies || {}).some(s => s === 'running');
      document.getElementById('btn-start').disabled = isRunning;
    } catch(err){ console.error(err); }
  }

  async function controlStrategy(name, action){
    await fetch(`/strategies/${name}/${action}`, {method:'POST'});
    updateStrategies();
  }

  async function loadConfig(){
    try {
      const res = await fetch('/config').then(r => r.json());
      const cfg = res.config || {};
      document.getElementById('cfg-strategy').value = cfg.strategy || '';
      document.getElementById('cfg-pairs').value = (cfg.pairs || []).join(',');
      document.getElementById('cfg-notional').value = cfg.notional ?? '';
      await loadSchema(cfg.strategy, cfg.params || {});
    } catch(err){ console.error(err); }
  }

  async function saveConfig(ev){
    if(ev) ev.preventDefault();
    const strategy = document.getElementById('cfg-strategy').value;
    const pairs = document.getElementById('cfg-pairs').value
      .split(',')
      .map(p => p.trim())
      .filter(Boolean);
    const notionalVal = document.getElementById('cfg-notional').value;
    const payload = {strategy, pairs};
    if(notionalVal){ payload.notional = parseFloat(notionalVal); }
    const params = {};
    document.querySelectorAll('#cfg-param-fields input').forEach(inp => {
      const name = inp.dataset.name;
      const type = (inp.dataset.type || '').toLowerCase();
      let val;
      if(inp.type === 'checkbox'){
        val = inp.checked;
      } else if(type === 'int'){
        if(inp.value !== '') val = parseInt(inp.value, 10);
      } else if(type === 'float' || type === 'number'){
        if(inp.value !== '') val = parseFloat(inp.value);
      } else {
        if(inp.value !== '') val = inp.value;
      }
      if(val !== undefined) params[name] = val;
    });
    if(Object.keys(params).length){ payload.params = params; }
    try {
      const res = await fetch('/config', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(res.ok){
        document.getElementById('cfg-result').textContent = 'Config saved';
      } else {
        const err = await res.json();
        document.getElementById('cfg-result').textContent = 'Error: ' + (err.detail || res.status);
      }
    } catch(err){
      document.getElementById('cfg-result').textContent = 'Error: ' + err;
    }
  }

  async function startBot(){
    try {
      await saveConfig();
      const res = await fetch('/bot/start', {method:'POST'});
      if(res.ok){
        document.getElementById('cfg-result').textContent = 'Bot started';
        document.getElementById('btn-start').disabled = true;
      } else {
        const err = await res.json();
        document.getElementById('cfg-result').textContent = 'Error: ' + (err.detail || res.status);
      }
    } catch(err) {
      if(err) console.error(err);
    }
    updateStrategies();
  }

  async function stopBot(){
    try {
      const res = await fetch('/bot/stop', {method:'POST'});
      if(res.ok){
        document.getElementById('cfg-result').textContent = 'Bot stopped';
        document.getElementById('btn-start').disabled = false;
      } else {
        const err = await res.json();
        document.getElementById('cfg-result').textContent = 'Error: ' + (err.detail || res.status);
      }
    } catch(err) {
      document.getElementById('cfg-result').textContent = 'Error: ' + err;
    }
    updateStrategies();
  }

  document.getElementById('cfg-strategy').addEventListener('change', e => loadSchema(e.target.value));
  loadSchema(document.getElementById('cfg-strategy').value);
  updateMetrics();
  updateStrategies();
  loadConfig();
  setInterval(()=>{updateMetrics(); updateStrategies();},5000);
  </script>
</body>
</html>

